<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOJO AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@100..800&family=Noto+Sans+SC:wght@300&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000000;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .header {
            background-image: url('image/MacBook Pro 16_ - 3.png');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 0 30px;
            border-radius: 0;
            margin: 0;
            text-align: left;
            width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            height: 55px;
            z-index: 1000;
        }

        .container {
            max-width: none;
            margin: 0;
            padding: 0;
            padding-top: 55px; /* ä¸ºå›ºå®šheaderç•™å‡ºç©ºé—´ */
        }


        .header h1 {
            color: #000000;
            font-size: 1.44rem;
            margin: 0;
            padding: 0;
            font-weight: 700;
            font-family: 'Sora', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            letter-spacing: 2px;
            line-height: 1;
        }

        .header p {
            display: none;
        }

        /* ä»»åŠ¡ç»Ÿè®¡é“¾æ¥æ ·å¼ */
        .stats-link {
            color: #000000;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .stats-link:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #80A5A0;
        }

        /* ç»Ÿè®¡å¼¹çª—æ ·å¼ */
        .stats-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }

        .stats-modal-content {
            background: #1e1e1e;
            border: 1px solid #333333;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .stats-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333333;
        }

        .stats-modal-header h2 {
            color: #F9FBFC;
            font-size: 1.5rem;
            margin: 0;
            font-weight: 600;
        }

        .stats-modal-close {
            color: #757575;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .stats-modal-close:hover {
            color: #F9FBFC;
        }

        .stats-modal-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .stats-modal-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333333;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stats-modal-card:hover {
            border-color: #80A5A0;
            background: rgba(128, 165, 160, 0.1);
        }

        .stats-modal-number {
            font-size: 2rem;
            font-weight: 700;
            color: #80A5A0;
            margin-bottom: 8px;
            line-height: 1;
        }

        .stats-modal-label {
            font-size: 0.9rem;
            color: #b0bec5;
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: transparent;
            padding: 20px 15px;
            border-radius: 0;
            text-align: center;
            border: 1px solid #333333;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #80A5A0;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #b0bec5;
            font-size: 0.9rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 0.9fr 2.1fr;
            gap: 0;
            height: calc(100vh - 55px); /* å‡å»headeré«˜åº¦ */
        }

        .panel {
            background: transparent;
            border-radius: 0;
            padding: 25px 30px;
            border-right: 1px solid #333333;
            overflow-y: auto;
            overflow-x: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .panel:first-child {
            background: #101010;
            position: relative;
            padding-bottom: 100px;
            box-sizing: border-box;
        }

        .panel:last-child {
            border-right: none;
            padding: 0 !important; /* ç§»é™¤ä¸Šä¸‹è¾¹è·ï¼Œç¡®ä¿è¦†ç›–åŸºç¡€æ ·å¼ */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        
        /* éšè—å³ä¾§é¢æ¿æ»šåŠ¨æ¡ */
        .panel:last-child::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }

        .panel h2 {
            color: #F9FBFC;
            margin-bottom: 20px;
            padding-bottom: 0;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .form-section {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #e0e0e0;
            font-size: 0.85rem;
            opacity: 0.5;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #333333;
            border-radius: 8px;
            font-size: 14px;
            background: transparent;
            color: #e0e0e0;
            transition: border-color 0.2s ease;
        }

        /* éšè—æ‰€æœ‰æ•°å­—è¾“å…¥æ¡†çš„ä¸Šä¸‹ç®­å¤´ */
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
            appearance: textfield; /* æ ‡å‡†å±æ€§ */
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none; /* Chrome, Safari, Edge */
            margin: 0;
        }

        /* å·¥ä½œæµç±»å‹ä¸‹æ‹‰æ¡†æ ·å¼ï¼Œä¸åº•éƒ¨å°ºå¯¸ä¸‹æ‹‰æ¡†ä¿æŒä¸€è‡´ */
        .form-group select {
            -webkit-appearance: none; /* Chrome, Safari, Edge */
            -moz-appearance: none; /* Firefox */
            appearance: none; /* æ ‡å‡†å±æ€§ */
            cursor: pointer;
            position: relative;
            z-index: 2;
            /* ä½¿ç”¨ä¸aspect-ratio-selectç›¸åŒçš„è‡ªå®šä¹‰ç®­å¤´ */
            background-image: url("data:image/svg+xml;charset=utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='1.5'><polyline points='6,9 12,15 18,9'/></svg>");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 14px;
            padding-right: 40px; /* ä¸ºç®­å¤´ç•™å‡ºç©ºé—´ */
        }

        .form-group select:hover {
            border-color: #666666;
        }

        .form-group select:focus {
            border-color: #80A5A0;
            outline: none;
            z-index: 1000; /* ç¡®ä¿ä¸‹æ‹‰æ¡†æ‰“å¼€æ—¶ï¼Œé€‰é¡¹åˆ—è¡¨æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ */
        }

        .form-group select option {
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 8px 12px;
        }

        .form-group select option:checked {
            background: #80A5A0;
            color: #000000;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #80A5A0;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #666666;
        }

        .form-group textarea {
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            resize: vertical;
        }

        .form-group textarea::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .form-group input[type="file"] {
            padding: 12px 16px;
        }

        .image-upload-area {
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 24px 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s ease;
            background: transparent;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-upload-area:hover {
            border-color: #80A5A0;
        }

        .image-upload-area.dragover {
            border-color: #80A5A0;
        }

        .upload-content {
            width: 100%;
        }

        .upload-icon {
            margin-bottom: 4px;
            opacity: 0.3;
            display: flex;
            justify-content: center;
        }

        .upload-icon svg {
            color: #e0e0e0;
        }

        .upload-main-text {
            font-size: 0.85rem;
            color: #e0e0e0;
            margin-bottom: 0;
            font-weight: 400;
            opacity: 0.3;
        }

        .image-preview {
            width: 100%;
            position: relative;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            object-fit: contain;
        }

        .image-actions {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-delete {
            background: transparent;
            border: none;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #888888;
            border-radius: 4px;
        }

        .btn-delete:hover {
            background: rgba(136, 136, 136, 0.1);
            color: #aaaaaa;
        }

        .btn-delete svg {
            display: block;
        }

        .upload-hint {
            font-size: 0.75rem;
            color: #666666;
            margin: 0;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .panel::-webkit-scrollbar {
            width: 6px;
        }

        .panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .panel::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 3px;
        }

        .panel:hover::-webkit-scrollbar-thumb {
            background: rgba(128, 165, 160, 0.3);
        }

        .panel::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 165, 160, 0.5);
        }


        .btn {
            background: transparent;
            color: #80A5A0;
            border: 1px solid #80A5A0;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #80A5A0;
            color: #000000;
        }

        .btn-fixed-bottom {
            width: 100px;
            height: 40px;
            background: #99D1CA;
            color: #000000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            flex-shrink: 0;
        }

        .btn-fixed-bottom:hover {
            background: #7BC4BB;
            color: #000000;
        }

        .btn-fixed-bottom::before {
            display: none;
        }

        .bottom-background {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 30vw;
            height: 80px;
            background: #101010;
            border-top: 1px solid #333333;
            border-right: 1px solid #333333;
            z-index: 50;
            pointer-events: none;
        }

        .bottom-controls {
            position: fixed;
            bottom: 20px;
            left: 30px;
            right: calc(70vw + 30px);
            height: 40px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .aspect-ratio-select {
            background: transparent;
            border: 1px solid #333333;
            border-radius: 8px;
            color: #e0e0e0;
            padding: 8px 24px 8px 12px;
            font-size: 14px;
            cursor: pointer;
            width: 150px;
            height: 40px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='1.5'><polyline points='6,9 12,15 18,9'/></svg>");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 14px;
            transition: border-color 0.2s ease;
            flex-shrink: 0;
        }

        .aspect-ratio-select:focus {
            border-color: #80A5A0;
            outline: none;
        }

        .aspect-ratio-select:hover {
            border-color: #666666;
        }

        .aspect-ratio-select option {
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 8px 12px;
        }

        .aspect-ratio-select option:checked {
            background: #80A5A0;
            color: #000000;
        }

        /* ä»»åŠ¡ç›‘æ§å±•å¼€æ”¶èµ·æ ·å¼ */
        .monitoring-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: color 0.2s ease;
        }

        .monitoring-header:hover {
            color: #99D1CA;
        }

        .collapse-arrow {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
            opacity: 0.7;
        }

        .collapse-arrow.collapsed {
            transform: rotate(-90deg);
        }

        .stats-container {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.2s ease, margin-bottom 0.3s ease;
            max-height: 300px;
            opacity: 1;
            margin-bottom: 15px;
        }

        .stats-container.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }

        .stats-grid {
            transition: transform 0.3s ease;
        }

        .btn-secondary {
            color: #b0bec5;
            border-color: #b0bec5;
        }

        .btn-secondary:hover {
            background: #b0bec5;
            color: #000000;
        }

        .btn-success {
            color: #4caf50;
            border-color: #4caf50;
        }

        .btn-success:hover {
            background: #4caf50;
            color: #000000;
        }

        .btn-danger {
            color: #f44336;
            border-color: #f44336;
        }

        .btn-danger:hover {
            background: #f44336;
            color: #F9FBFC;
        }

        .task-list {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            min-height: 0; /* å…è®¸flexå­å…ƒç´ ç¼©å°ï¼Œç¡®ä¿æ»šåŠ¨ç”Ÿæ•ˆ */
            padding: 0; /* ç§»é™¤ä¸Šä¸‹è¾¹è·ï¼Œæ•´é¡µé¢æ»šåŠ¨ */
            margin: 0; /* ç§»é™¤æ‰€æœ‰å¤–è¾¹è· */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        
        /* ç§»é™¤ç¬¬ä¸€ä¸ªä»»åŠ¡é¡¹çš„é¡¶éƒ¨é—´è· */
        .task-list > .task-item:first-child {
            margin-top: 0;
        }
        
        /* éšè—task-listæ»šåŠ¨æ¡ */
        .task-list::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }

        .task-item {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-bottom: 30px;
            border: none;
        }

        /* å›¾ç‰‡å®«æ ¼å¸ƒå±€æ ·å¼ */
        .image-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 0;
            padding: 0;
            justify-content: flex-start; /* å·¦å¯¹é½ */
            align-items: flex-start;
        }

        .image-grid-item {
            position: relative;
            height: 100%;
            width: 100%;
            min-height: 500px; /* æœ€å°é«˜åº¦ï¼Œé˜²æ­¢åˆå§‹æ¸²æŸ“æ—¶å°ºå¯¸é”™è¯¯ */
            max-height: 100%; /* æœ€å¤§é«˜åº¦é™åˆ¶ */
            max-width: 100%; /* æœ€å¤§å®½åº¦é™åˆ¶ï¼Œé˜²æ­¢å¤§å›¾é—ªç° */
            border-radius: 0; /* æ— åœ†è§’ */
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center; /* å›¾ç‰‡å±…ä¸­ */
            box-sizing: border-box; /* ç¡®ä¿å°ºå¯¸è®¡ç®—åŒ…å«border */
        }

        .image-grid-item img {
            max-width: 100% !important; /* å¼ºåˆ¶é™åˆ¶æœ€å¤§å®½åº¦ */
            max-height: 100% !important; /* å¼ºåˆ¶é™åˆ¶æœ€å¤§é«˜åº¦ */
            width: auto;
            height: auto;
            object-fit: contain; /* ä¿æŒæ¯”ä¾‹ï¼Œå±…ä¸­æ˜¾ç¤º */
            display: block; /* é¿å…å†…è”å…ƒç´ çš„é»˜è®¤è¡Œä¸º */
            opacity: 0; /* åˆå§‹éšè—ï¼Œé˜²æ­¢é—ªç° */
            transition: opacity 0.2s ease; /* æ·¡å…¥æ•ˆæœ */
            box-sizing: border-box; /* ç¡®ä¿å°ºå¯¸è®¡ç®—æ­£ç¡® */
        }
        
        .image-grid-item img[complete],
        .image-grid-item img[data-loaded] {
            opacity: 1; /* åŠ è½½å®Œæˆåæ˜¾ç¤º */
        }

        .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 15px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .image-grid-item:hover .image-overlay {
            transform: translateY(0);
        }

        /* å³é”®èœå•æ ·å¼ */
        .image-context-menu {
            position: fixed;
            background: #1e1e1e;
            border: 1px solid #333333;
            border-radius: 6px;
            padding: 4px 0;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            display: none;
        }

        .image-context-menu-item {
            padding: 8px 16px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .image-context-menu-item:hover {
            background-color: #2d2d2d;
        }

        .image-context-menu-item svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .image-index {
            color: #F9FBFC;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .image-actions-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-image-action {
            background: rgba(128, 165, 160, 0.9);
            color: #000;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        .btn-image-action:hover {
            background: #99D1CA;
            transform: scale(1.05);
        }


        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .image-modal-content {
            margin: auto;
            display: block;
            width: auto;
            height: auto;
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
            animation: modalZoom 0.3s;
            padding: 0;
        }

        @keyframes modalZoom {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(128, 165, 160, 0.2);
            border-top: 4px solid #80A5A0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #F9FBFC;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: #80A5A0;
        }

        /* ä»»åŠ¡è¯¦æƒ…é¢„è§ˆæ¨¡æ€æ¡† */
        .task-detail-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
        }

        .task-detail-content {
            margin: 0;
            max-width: 95vw;
            width: 95vw;
            background: transparent;
            border-radius: 0;
            padding: 0;
            position: relative;
            max-height: 95vh;
            overflow: visible;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 120px; /* ä¸ºåº•éƒ¨ç¼©ç•¥å›¾ç•™å‡ºç©ºé—´ */
        }

        .task-detail-modal .modal-close {
            position: fixed;
            top: 20px;
            right: 35px;
            z-index: 2001;
        }

        .task-detail-container {
            display: flex;
            gap: 40px;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 95vw;
        }

        .task-detail-left {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-detail-left .image-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .task-detail-left .image-grid-item {
            height: auto;
            max-height: 80vh;
            width: auto;
            max-width: 60vw;
            cursor: default;
            pointer-events: none;
            background: transparent;
            border: none;
            padding: 0;
        }
        
        .task-detail-left .image-grid-item img {
            max-width: 100%;
            max-height: 80vh;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .task-detail-left .image-grid-item:hover {
            transform: none;
            border-color: #333333;
            box-shadow: none;
        }

        .task-detail-left .image-grid-item:hover img {
            transform: none;
        }

        .task-detail-left .image-overlay {
            display: none;
        }

        .task-detail-image-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 1;
        }

        .task-detail-left .image-grid-item:hover .task-detail-image-overlay {
            opacity: 1;
            pointer-events: none; /* ä¿æŒ noneï¼Œé¿å…é®æŒ¡å›¾ç‰‡å³é”® */
        }
        
        .task-detail-image-action {
            pointer-events: auto; /* åªæœ‰æŒ‰é’®æœ¬èº«å¯ä»¥ç‚¹å‡» */
            background: rgba(128, 165, 160, 0.9);
            color: #000;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        .task-detail-image-action:hover {
            background: #99D1CA;
            transform: scale(1.05);
        }

        .task-detail-right {
            flex: 0 0 auto;
            max-width: 500px;
            min-width: 300px;
        }

        .task-detail-right .generation-params {
            height: auto;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            background: transparent;
            border: none;
            padding: 0;
            cursor: default !important;
            pointer-events: none !important;
        }

        .task-detail-right .generation-params * {
            pointer-events: none !important;
        }

        .task-detail-right .param-value {
            display: block !important;
            -webkit-line-clamp: unset !important;
            line-clamp: unset !important;
            -webkit-box-orient: unset !important;
            max-height: none !important;
            overflow: visible !important;
            text-overflow: unset !important;
            white-space: normal !important;
        }

        .task-detail-right .params-content {
            overflow: visible !important;
            height: auto !important;
            max-height: none !important;
        }

        .task-detail-right .params-content::after {
            display: none !important;
        }

        .task-detail-preview {
            flex: 0 0 auto;
            width: 80px;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2001;
        }

        .task-detail-preview::-webkit-scrollbar {
            width: 6px;
        }

        .task-detail-preview::-webkit-scrollbar-track {
            background: transparent;
        }

        .task-detail-preview::-webkit-scrollbar-thumb {
            background: rgba(128, 165, 160, 0.3);
            border-radius: 3px;
        }

        .task-detail-preview::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 165, 160, 0.5);
        }

        /* åº•éƒ¨ç¼©ç•¥å›¾åˆ—è¡¨æ ·å¼ */
        .task-detail-bottom-thumbnails {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            z-index: 2002;
            max-width: 90vw;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .task-detail-bottom-thumbnails::-webkit-scrollbar {
            height: 4px;
        }

        .task-detail-bottom-thumbnails::-webkit-scrollbar-track {
            background: transparent;
        }

        .task-detail-bottom-thumbnails::-webkit-scrollbar-thumb {
            background: rgba(128, 165, 160, 0.5);
            border-radius: 2px;
        }

        .task-detail-bottom-thumbnails::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 165, 160, 0.7);
        }

        .thumbnail-item {
            width: 80px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
        }

        .thumbnail-item:hover {
            border-color: rgba(128, 165, 160, 0.5);
            transform: scale(1.05);
        }

        .thumbnail-item.active {
            border-color: #80A5A0;
            box-shadow: 0 0 10px rgba(128, 165, 160, 0.5);
        }

        .thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item {
            width: 70px;
            height: 70px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
        }

        .preview-item:hover {
            border-color: #80A5A0;
            transform: scale(1.05);
        }

        .preview-item.active {
            border-color: #80A5A0;
            box-shadow: 0 0 10px rgba(128, 165, 160, 0.5);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @media (max-width: 1024px) {
            .task-detail-container {
                flex-direction: column;
            }

            .task-detail-left {
                min-width: 100%;
            }
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .task-item {
                padding: 15px;
                margin-bottom: 15px;
            }

            .task-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                font-size: 12px;
            }

            .task-header-left {
                flex-wrap: wrap;
            }

            .task-header-right {
                width: 100%;
            }

            .result-container {
                flex-direction: column;
                gap: 15px;
            }

            .image-grid {
                grid-template-columns: repeat(auto-fit, 200px);
                gap: 8px;
            }
            
            .image-grid-item {
                height: 200px;
            }
            
            .generation-params {
                height: 200px;
            }
            
            .params-content {
                height: calc(200px - 30px);
                max-height: calc(200px - 30px);
            }
            
            .image-overlay {
                padding: 10px;
            }

            .modal-close {
                top: 10px;
                right: 20px;
                font-size: 30px;
            }
        }

        .task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
            font-size: 13px;
            color: #999999;
        }

        .task-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .task-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .task-separator {
            color: #666666;
            margin: 0 5px;
        }

        .task-id {
            font-family: monospace;
            color: #80A5A0;
            font-size: 13px;
            font-weight: 600;
        }

        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .task-meta-label {
            color: #666666;
        }

        .task-meta-value {
            color: #e0e0e0;
        }

        .task-status {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-pending {
            background: #ffc107;
            color: #212529;
        }

        .status-running {
            background: #17a2b8;
            color: #F9FBFC;
        }

        .status-completed {
            background: #28a745;
            color: #F9FBFC;
        }

        .status-failed {
            background: #dc3545;
            color: #F9FBFC;
        }


        .task-details {
            font-size: 13px;
            color: #999999;
            line-height: 1.6;
        }

        /* ç»“æœå®¹å™¨ - åªåŒ…å«å›¾ç‰‡ */
        .result-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px; /* æç¤ºè¯å’Œå›¾ç‰‡æ¡†ä¹‹é—´çš„é—´è· */
            align-items: stretch;
            border: none;
            border-radius: 8px;
            padding: 0 16px; /* åªä¿ç•™å·¦å³paddingï¼Œç§»é™¤ä¸Šä¸‹padding */
            cursor: pointer;
            transition: opacity 0.2s ease;
            background: rgba(42, 42, 42, 0.5); /* å¡«å……è‰² */
        }

        .result-container:hover {
            opacity: 0.9;
        }
        
        /* 4å¼ å›¾ç‰‡æ—¶ï¼Œå»æ‰å®¹å™¨æ ·å¼ */
        .result-container.image-container-4x1 {
            background: transparent !important; /* é€æ˜èƒŒæ™¯ */
            padding: 0 !important; /* ç§»é™¤padding */
            margin-top: 6px; /* å‡å°ä¸æç¤ºè¯çš„é—´è· */
            cursor: pointer; /* ä¿æŒå¯ç‚¹å‡» */
        }
        
        .result-container.image-container-4x1:hover {
            opacity: 1; /* hoveræ—¶ä¿æŒä¸é€æ˜ */
        }

        .result-container .image-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 0;
            padding: 0;
            justify-content: center; /* å›¾ç‰‡å±…ä¸­ */
            align-items: stretch; /* æ‹‰ä¼¸ä»¥å¡«å……å®¹å™¨é«˜åº¦ */
            width: 100%;
            min-height: 500px; /* æœ€å°é«˜åº¦ */
            max-height: 600px; /* æœ€å¤§é«˜åº¦é™åˆ¶ï¼Œé˜²æ­¢é—ªç°å¤§å›¾ */
            height: auto; /* æ”¹ä¸ºautoï¼Œé¿å…åˆå§‹æ¸²æŸ“é—®é¢˜ */
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
            box-sizing: border-box; /* ç¡®ä¿å°ºå¯¸è®¡ç®—æ­£ç¡® */
        }
        
        /* 1:1æ¯”ä¾‹å››å¼ å›¾ç‰‡æ¨ªå‘æ’åˆ— */
        .result-container .image-grid.image-grid-4x1 {
            flex-wrap: nowrap; /* ä¸æ¢è¡Œ */
            justify-content: flex-start; /* å·¦å¯¹é½ */
            gap: 0; /* ç§»é™¤gapï¼Œé¿å…ç•™ç™½ */
            align-items: stretch; /* æ‹‰ä¼¸å¯¹é½ï¼Œç¡®ä¿æ‰€æœ‰å›¾ç‰‡é¡¹é«˜åº¦ä¸€è‡´ */
            height: auto; /* é«˜åº¦è‡ªé€‚åº”ï¼Œç­‰äºå›¾ç‰‡é¡¹é«˜åº¦ */
            width: 100%; /* å®½åº¦ä¸å…¶ä»–å›¾ç‰‡åˆ—è¡¨ä¿æŒä¸€è‡´ */
            padding: 0; /* ç§»é™¤å†…è¾¹è· */
            margin: 0; /* ç§»é™¤å¤–è¾¹è· */
        }
        
        .result-container .image-grid.image-grid-4x1 .image-grid-item {
            flex: 0 0 25%; /* æ¯å¼ å›ºå®šå 25%å®½åº¦ */
            min-width: 0; /* å…è®¸ç¼©å° */
            max-width: 25%; /* æ¯å¼ æœ€å¤šå 25% */
            aspect-ratio: 1; /* ä¿æŒ1:1æ¯”ä¾‹ï¼Œé«˜åº¦è‡ªåŠ¨ç­‰äºå®½åº¦ */
            padding: 0; /* ç§»é™¤å†…è¾¹è· */
            margin: 0; /* ç§»é™¤å¤–è¾¹è· */
            border: none !important; /* ç§»é™¤æ‰€æœ‰è¾¹æ¡† */
            position: relative; /* ç”¨äºå®šä½å›¾ç‰‡ */
            box-sizing: border-box; /* åŒ…å«borderåœ¨å®½åº¦è®¡ç®—å†… */
            background: transparent !important; /* é€æ˜èƒŒæ™¯ */
        }
        
        .result-container .image-grid.image-grid-4x1 .image-grid-item img {
            width: 100% !important; /* å®½åº¦å¡«å……å®¹å™¨ */
            height: 100% !important; /* é«˜åº¦å¡«å……å®¹å™¨ */
            max-width: 100% !important;
            max-height: 100% !important;
            object-fit: contain !important; /* ä¿æŒ1:1æ¯”ä¾‹ï¼Œä¸è£å‰ª */
            object-position: center; /* å±…ä¸­æ˜¾ç¤º */
            position: absolute; /* ç»å¯¹å®šä½ï¼Œå¡«å……å®¹å™¨ */
            top: 0;
            left: 0;
        }
        
        /* æç¤ºè¯æ ·å¼ - åœ¨çº¿æ¡†å¤– */
        .prompt-only {
            margin: 0;
            padding: 0 0 0 0;
            width: 100%;
        }
        
        .prompt-text {
            color: #e0e0e0;
            font-size: 0.9rem;
            line-height: 1.5;
            word-wrap: break-word;
            margin: 0;
            padding: 0;
            text-align: left;
        }

        /* ç”Ÿæˆå‚æ•°æ ·å¼ */
        .generation-params {
            padding: 0;
            background: transparent;
            border-radius: 0;
            border: none;
            width: 100%;
            height: auto;
            min-height: auto;
            overflow: visible;
            box-sizing: border-box;
            flex-shrink: 0;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        .generation-params:hover {
            background: transparent;
        }

        .params-content {
            overflow: hidden !important;
            font-size: 0.8rem;
            color: #b0bec5;
            height: 200px;
            max-height: 200px;
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }

        .params-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to bottom, transparent, #000000);
            pointer-events: none;
            z-index: 1;
        }

        .param-item {
            margin-bottom: 10px;
            overflow: visible;
            word-wrap: break-word;
            word-break: break-word;
            box-sizing: border-box;
            width: 100%;
            min-width: 0;
        }

        .param-item:last-child {
            margin-bottom: 0;
        }

        .param-label {
            color: #999999;
            font-weight: 500;
            margin-bottom: 4px;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .param-value {
            color: #e0e0e0;
            line-height: 1.5;
            overflow: visible !important;
            display: block !important;
            word-break: break-word;
            word-wrap: break-word;
            overflow-wrap: break-word;
            box-sizing: border-box;
            white-space: normal;
        }

        .param-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .param-item-inline {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .param-item-inline .param-label {
            color: #999999;
            font-weight: 500;
            margin-bottom: 0;
        }

        .param-item-inline .param-value {
            color: #e0e0e0;
        }

        .batch-item {
            background: transparent;
            padding: 15px 0;
            border-radius: 0;
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333333;
        }

        .result-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 0;
            margin: 10px 0;
        }

        .connection-status {
            position: relative;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
        }

        .connected {
            background: #80A5A0;
            color: #F9FBFC;
        }

        .disconnected {
            background: #dc3545;
            color: #F9FBFC;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .panel {
                border-right: none;
                border-bottom: 1px solid #333333;
                height: auto;
                overflow-y: visible;
            }
            
            .panel:last-child {
                border-bottom: none;
            }
            
            .panel:first-child {
                background: #101010;
                position: relative;
                padding-bottom: 100px;
                height: auto;
                overflow-y: visible;
            }

            .btn-fixed-bottom {
                position: relative;
                bottom: auto;
                left: auto;
                right: auto;
                width: 100%;
                margin-top: 20px;
                z-index: auto;
                background: #99D1CA;
                color: #000000;
                border: none;
                height: 40px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 700;
                text-align: center;
            }

            .btn-fixed-bottom:hover {
                background: #7BC4BB;
                color: #000000;
            }

            .btn-fixed-bottom::before {
                display: none;
            }

            .bottom-controls {
                position: relative;
                bottom: auto;
                left: auto;
                right: auto;
                margin-top: 20px;
                padding: 0;
                display: flex;
                gap: 15px;
                align-items: center;
                justify-content: space-between;
            }

            .aspect-ratio-select {
                width: 150px;
                flex-shrink: 0;
            }

            .mobile-only {
                display: flex !important;
            }

            .bottom-controls:not(.mobile-only) {
                display: none !important;
            }

            .monitoring-header {
                font-size: 1rem;
            }

            .collapse-arrow {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- å›¾ç‰‡å³é”®èœå• -->
    <div id="imageContextMenu" class="image-context-menu"></div>

    <div class="bottom-background"></div>
    
    <div class="bottom-controls">
        <select class="aspect-ratio-select" id="aspectRatio" onchange="updateAspectRatio()">
            <option value="custom">è‡ªå®šä¹‰å°ºå¯¸</option>
            <option value="1:1">1:1 æ­£æ–¹å½¢</option>
            <option value="16:9">16:9 æ¨ªå±</option>
            <option value="9:16">9:16 ç«–å±</option>
            <option value="4:3">4:3 æ¨ªå±</option>
            <option value="3:4">3:4 ç«–å±</option>
            <option value="3:2">3:2 æ¨ªå±</option>
            <option value="2:3">2:3 ç«–å±</option>
        </select>
        <button class="btn-fixed-bottom" onclick="submitSingle()">ç”Ÿæˆ</button>
    </div>

    <div class="header">
        <h1>HOJO AI</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="#" class="stats-link" onclick="event.preventDefault(); openStatsModal();">ä»»åŠ¡ç»Ÿè®¡</a>
            <div class="connection-status disconnected" id="connectionStatus">
                ğŸ”´ æ£€æµ‹è¿æ¥ä¸­...
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-grid">
            <!-- å·¦ä¾§ï¼šå›¾ç‰‡ç”Ÿæˆ -->
            <div class="panel">
                <h2>å›¾ç‰‡ç”Ÿæˆ</h2>
                
                <div class="form-section">
                    <div class="form-group">
                        <label>APIæœåŠ¡å™¨åœ°å€</label>
                        <input type="text" id="apiServer" value="http://localhost:8001" placeholder="http://localhost:8001">
                </div>

                <div class="form-group">
                        <label>å·¥ä½œæµç±»å‹</label>
                        <select id="workflowType" onchange="switchWorkflow()">
                            <option value="qwen_text2img">Qwen æ–‡ç”Ÿå›¾</option>
                            <option value="qwen_img2img">Qwen å›¾ç”Ÿå›¾</option>
                            <option value="rembg">è§’è‰²æŠ å›¾</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="imageUploadGroup">
                    <label>è¾“å…¥å›¾ç‰‡</label>
                    <div class="image-upload-area" id="imageUploadArea">
                        <input type="file" id="inputImage" accept="image/*" style="display: none;">
                        <div class="upload-content" id="uploadContent">
                            <div class="upload-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21,15 16,10 5,21"/>
                                </svg>
                            </div>
                            <div class="upload-main-text">ä¸Šä¼ å‚è€ƒå›¾</div>
                        </div>
                        <div class="image-preview" id="imagePreview" style="display: none;">
                            <img id="previewImg" src="" alt="é¢„è§ˆå›¾ç‰‡">
                            <div class="image-actions">
                                <div class="upload-hint">ç‚¹å‡»ä¸Šæ–¹å›¾ç‰‡å¯é‡æ–°é€‰æ‹©æ–‡ä»¶</div>
                                <button type="button" class="btn-delete" onclick="removeImage()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3,6 5,6 21,6"></polyline>
                                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="promptGroup">
                    <label>æç¤ºè¯</label>
                    <textarea id="prompt" rows="5" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å›¾åƒ..." style="min-height: 100px;"></textarea>
                </div>

                <div class="form-group" id="negativePromptGroup">
                    <label>è´Ÿé¢æç¤ºè¯</label>
                    <textarea id="negativePrompt" rows="2" placeholder="ä¸å¸Œæœ›å‡ºç°çš„å…ƒç´ ..."></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;" id="sizeGroup">
                    <div class="form-group">
                        <label>å®½åº¦</label>
                        <input type="number" id="width" value="1024" min="64" max="2048" step="64">
                    </div>
                    <div class="form-group">
                        <label>é«˜åº¦</label>
                        <input type="number" id="height" value="1024" min="64" max="2048" step="64">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;" id="samplingGroup">
                    <div class="form-group">
                        <label>é‡‡æ ·æ­¥æ•°</label>
                        <input type="number" id="steps" value="8" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>CFGå¼ºåº¦</label>
                        <input type="number" id="cfg" value="1" min="0" max="30" step="0.1">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;" id="advancedGroup">
                    <div class="form-group">
                        <label>ç§å­å€¼ (å¯é€‰)</label>
                        <input type="number" id="seed" placeholder="ç•™ç©ºéšæœº">
                    </div>
                    <div class="form-group">
                        <label>ç”Ÿæˆæ•°é‡</label>
                        <input type="number" id="batchSize" value="1" min="1" max="4" title="æ¯ä¸ªæç¤ºè¯ç”Ÿæˆçš„å›¾ç‰‡æ•°é‡">
                    </div>
                </div>

                <!-- Qwen å›¾ç”Ÿå›¾ä¸“ç”¨å‚æ•° -->
                <div style="display: none;" id="img2imgParams">
                    <div class="form-group">
                        <label>é¢å¤–è¾“å…¥å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="image-upload-area" id="imageUploadArea2">
                            <input type="file" id="inputImage2" accept="image/*" style="display: none;">
                            <div class="upload-content" id="uploadContent2">
                                <div class="upload-main-text" style="font-size: 0.9rem;">ä¸Šä¼ ç¬¬2å¼ å›¾ç‰‡</div>
                            </div>
                            <div class="image-preview" id="imagePreview2" style="display: none;">
                                <img id="previewImg2" src="" alt="é¢„è§ˆå›¾ç‰‡2">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="image-upload-area" id="imageUploadArea3">
                            <input type="file" id="inputImage3" accept="image/*" style="display: none;">
                            <div class="upload-content" id="uploadContent3">
                                <div class="upload-main-text" style="font-size: 0.9rem;">ä¸Šä¼ ç¬¬3å¼ å›¾ç‰‡</div>
                            </div>
                            <div class="image-preview" id="imagePreview3" style="display: none;">
                                <img id="previewImg3" src="" alt="é¢„è§ˆå›¾ç‰‡3">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç§»åŠ¨ç«¯åº•éƒ¨æ§ä»¶ -->
                <div class="bottom-controls mobile-only" style="display: none;">
                    <select class="aspect-ratio-select" id="aspectRatioMobile" onchange="updateAspectRatioMobile()">
                        <option value="custom">è‡ªå®šä¹‰å°ºå¯¸</option>
                        <option value="1:1">1:1 æ­£æ–¹å½¢</option>
                        <option value="16:9">16:9 æ¨ªå±</option>
                        <option value="9:16">9:16 ç«–å±</option>
                        <option value="4:3">4:3 æ¨ªå±</option>
                        <option value="3:4">3:4 ç«–å±</option>
                        <option value="3:2">3:2 æ¨ªå±</option>
                        <option value="2:3">2:3 ç«–å±</option>
                    </select>
                    <button class="btn-fixed-bottom" onclick="submitSingle()">ç”Ÿæˆ</button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šä»»åŠ¡åˆ—è¡¨ -->
            <div class="panel">
                <div class="task-list" id="taskList">
                    <div style="text-align: center; padding: 50px; color: #999;">
                        æš‚æ— ä»»åŠ¡
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡ç›‘æ§ç»Ÿè®¡æ•°æ®ï¼ˆå·²ç§»è‡³Headerï¼Œæ­¤å¤„ä¿ç•™ç”¨äºæ•°æ®æ›´æ–°ï¼‰ -->
            <div style="display: none;">
                <div class="stats-container" id="statsContainer">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalTasks">0</div>
                            <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="runningTasks">0</div>
                            <div class="stat-label">è¿›è¡Œä¸­</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completedTasks">0</div>
                            <div class="stat-label">å·²å®Œæˆ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="failedTasks">0</div>
                            <div class="stat-label">å¤±è´¥</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()" style="display: none;">
        <span class="modal-close" onclick="closeImageModal()">&times;</span>
        <img class="image-modal-content" id="modalImage" onclick="event.stopPropagation()" style="max-width: 95vw; max-height: 95vh; width: auto; height: auto; object-fit: contain; display: none;">
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="taskDetailModal" class="task-detail-modal" onclick="closeTaskDetailModal()" oncontextmenu="event.preventDefault();" style="display: none;">
        <div class="task-detail-content" onclick="event.stopPropagation()" oncontextmenu="event.stopPropagation();">
            <span class="modal-close" onclick="closeTaskDetailModal()">&times;</span>
            <div class="task-detail-container">
                <div class="task-detail-left">
                    <div id="taskDetailImages"></div>
                </div>
                <div class="task-detail-right">
                    <div id="taskDetailParams"></div>
                </div>
                <div class="task-detail-preview">
                    <div id="taskDetailPreviewList"></div>
                </div>
                <div id="taskDetailBottomThumbnails" class="task-detail-bottom-thumbnails" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡ç»Ÿè®¡å¼¹çª— -->
    <div id="statsModal" class="stats-modal" onclick="closeStatsModal()" style="display: none;">
        <div class="stats-modal-content" onclick="event.stopPropagation()">
            <div class="stats-modal-header">
                <h2>ä»»åŠ¡ç»Ÿè®¡</h2>
                <span class="stats-modal-close" onclick="closeStatsModal()">&times;</span>
            </div>
            <div class="stats-modal-grid">
                <div class="stats-modal-card">
                    <div class="stats-modal-number" id="statsModalTotalTasks">0</div>
                    <div class="stats-modal-label">æ€»ä»»åŠ¡æ•°</div>
                </div>
                <div class="stats-modal-card">
                    <div class="stats-modal-number" id="statsModalRunningTasks">0</div>
                    <div class="stats-modal-label">è¿›è¡Œä¸­</div>
                </div>
                <div class="stats-modal-card">
                    <div class="stats-modal-number" id="statsModalCompletedTasks">0</div>
                    <div class="stats-modal-label">å·²å®Œæˆ</div>
                </div>
                <div class="stats-modal-card">
                    <div class="stats-modal-number" id="statsModalFailedTasks">0</div>
                    <div class="stats-modal-label">å¤±è´¥</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BatchGenerationManager {
            constructor() {
                this.apiServer = 'http://localhost:8001';
                this.ws = null;
                this.tasks = {};
                this.refreshInterval = null;
                this.apiConnected = false;
                this._manuallyPaused = false;
                this.retryCount = 0;
                this.maxRetries = 3;
                this.viewMode = 'all'; // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€ï¼ŒåŒ…æ‹¬ generating
                this.currentImageIndex = 0; // å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡ç´¢å¼•ï¼ˆç”¨äºå¤šå›¾åˆ‡æ¢ï¼‰
                
                // åˆå§‹åŒ–æ—¶åŠ è½½æœ¬åœ°ä¿å­˜çš„ä»»åŠ¡å‚æ•°
                this.loadTasksFromLocalStorage();
                this.init();
            }

            // ä¿å­˜ä»»åŠ¡åˆ°localStorage
            saveTaskToLocalStorage(taskId, taskData) {
                try {
                    const key = `task_${taskId}`;
                    localStorage.setItem(key, JSON.stringify(taskData));
                    console.log('ğŸ’¾ æœ¬åœ°ä¿å­˜ä»»åŠ¡å‚æ•°:', taskId);
                } catch (error) {
                    console.warn('âš ï¸ localStorageä¿å­˜å¤±è´¥:', error);
                }
            }

            // ä»localStorageåŠ è½½æ‰€æœ‰ä»»åŠ¡
            loadTasksFromLocalStorage() {
                try {
                    const savedTasks = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('task_')) {
                            const taskId = key.substring(5);
                            const taskData = JSON.parse(localStorage.getItem(key));
                            savedTasks[taskId] = taskData;
                        }
                    }
                    
                    if (Object.keys(savedTasks).length > 0) {
                        console.log('ğŸ“¥ ä»localStorageæ¢å¤ä»»åŠ¡å‚æ•°:', Object.keys(savedTasks).length, 'ä¸ª');
                        this.tasks = savedTasks;
                    }
                } catch (error) {
                    console.warn('âš ï¸ localStorageåŠ è½½å¤±è´¥:', error);
                }
            }


            init() {
                // WebSocket åŠŸèƒ½å·²ç¦ç”¨ï¼Œä½¿ç”¨è½®è¯¢æ–¹å¼æ›´æ–°ä»»åŠ¡çŠ¶æ€
                // this.connectWebSocket();
                this.refreshTasks();
                
                // å®šæœŸåˆ·æ–° (åªåœ¨APIè¿æ¥æ­£å¸¸æ—¶)
                this.startRefreshTimer();
            }

            startRefreshTimer() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                this.refreshInterval = setInterval(() => {
                    // åªæœ‰åœ¨æ²¡æœ‰ç”Ÿæˆä¸­ä»»åŠ¡æ—¶æ‰åˆ·æ–°ï¼Œé¿å…çŠ¶æ€å†²çª
                    const hasGeneratingTasks = Object.values(this.tasks).some(task => task.status === 'generating');
                    if (this.apiConnected && !hasGeneratingTasks) {
                        console.log('ğŸ”„ å®šæœŸåˆ·æ–°ï¼ˆæ— ç”Ÿæˆä¸­ä»»åŠ¡ï¼‰');
                        this.refreshTasks();
                    } else if (hasGeneratingTasks) {
                        console.log('â¸ï¸ è·³è¿‡å®šæœŸåˆ·æ–°ï¼ˆæœ‰ç”Ÿæˆä¸­ä»»åŠ¡ï¼‰');
                    }
                }, 10000);
            }

            stopRefreshTimer() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
            }

            connectWebSocket() {
                // WebSocket æ˜¯å¯é€‰çš„ï¼Œå¦‚æœåç«¯ä¸æ”¯æŒåˆ™é™é»˜å¤±è´¥
                // ä»»åŠ¡çŠ¶æ€æ›´æ–°é€šè¿‡è½®è¯¢å®ç°ï¼Œä¸ä¾èµ– WebSocket
                const wsUrl = this.apiServer.replace('http', 'ws') + '/ws';
                
                try {
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        console.log('WebSocketè¿æ¥æˆåŠŸ');
                        this.updateConnectionStatus(true);
                    };

                    this.ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        if (message.type === 'task_update') {
                            this.updateTask(message.data);
                        }
                    };

                    this.ws.onclose = () => {
                        // é™é»˜å¤„ç†ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                        this.updateConnectionStatus(false);
                        
                        // 5ç§’åé‡è¿ï¼ˆå¦‚æœ WebSocket å¯ç”¨ï¼‰
                        setTimeout(() => {
                            if (this.ws && this.ws.readyState === WebSocket.CLOSED) {
                            this.connectWebSocket();
                            }
                        }, 5000);
                    };

                    this.ws.onerror = (error) => {
                        // é™é»˜å¤„ç† WebSocket é”™è¯¯ï¼Œä¸æ˜¾ç¤ºåœ¨æ§åˆ¶å°
                        // WebSocket æ˜¯å¯é€‰çš„ï¼Œä»»åŠ¡çŠ¶æ€é€šè¿‡è½®è¯¢æ›´æ–°
                        this.updateConnectionStatus(false);
                    };

                } catch (error) {
                    // é™é»˜å¤„ç†è¿æ¥å¤±è´¥
                    this.updateConnectionStatus(false);
                }
            }

            updateConnectionStatus(connected) {
                // WebSocket çŠ¶æ€æ›´æ–°ï¼Œé™é»˜å¤„ç†ï¼Œä¸å½±å“UI
                // ä¸»è¦çš„è¿æ¥çŠ¶æ€ç”± API è°ƒç”¨æ¥åˆ¤æ–­
                // è¿™æ ·é¿å… WebSocket è¿æ¥å¤±è´¥å¯¼è‡´çš„UIæŠ–åŠ¨
            }

            async apiCall(endpoint, method = 'GET', data = null, showError = false) {
                const url = `${this.apiServer}${endpoint}`;
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    // APIè°ƒç”¨æˆåŠŸï¼Œé‡ç½®è¿æ¥çŠ¶æ€
                    if (!this.apiConnected) {
                        this.apiConnected = true;
                        this.retryCount = 0;
                        this.updateApiStatus(true);
                        // åªæœ‰åœ¨æ²¡æœ‰æ‰‹åŠ¨æš‚åœçš„æƒ…å†µä¸‹æ‰é‡æ–°å¯åŠ¨å®šæ—¶å™¨
                        if (!this._manuallyPaused) {
                        this.startRefreshTimer();
                        }
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('APIè°ƒç”¨å¤±è´¥:', error);
                    
                    // è®¾ç½®APIè¿æ¥çŠ¶æ€ä¸ºå¤±è´¥
                    this.apiConnected = false;
                    this.updateApiStatus(false, error.message);
                    
                    // åªæœ‰åœ¨æ˜ç¡®è¦æ±‚æ˜¾ç¤ºé”™è¯¯æ—¶æ‰å¼¹çª—
                    if (showError) {
                        this.showErrorMessage(`APIè°ƒç”¨å¤±è´¥: ${error.message}`);
                    }
                    
                    throw error;
                }
            }

            showErrorMessage(message) {
                this.showToast(message, '#c62828');
            }

            showSuccessMessage(message) {
                this.showToast(message, '#80A5A0');
            }

            // æ˜¾ç¤ºå›¾ç‰‡å³é”®èœå•
            showImageContextMenu(event, imageUrl) {
                // ç§»é™¤å·²å­˜åœ¨çš„èœå•
                const existingMenu = document.getElementById('imageContextMenu');
                if (existingMenu) {
                    existingMenu.remove();
                }

                // åˆ›å»ºèœå•
                const menu = document.createElement('div');
                menu.id = 'imageContextMenu';
                menu.className = 'image-context-menu';
                menu.style.left = `${event.clientX}px`;
                menu.style.top = `${event.clientY}px`;
                menu.style.display = 'block';

                // å¤åˆ¶å›¾ç‰‡é€‰é¡¹
                const copyItem = document.createElement('div');
                copyItem.className = 'image-context-menu-item';
                copyItem.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    <span>å¤åˆ¶å›¾ç‰‡</span>
                `;
                copyItem.onclick = () => {
                    this.copyImageToClipboard(imageUrl);
                    menu.remove();
                };

                // æ–°æ ‡ç­¾é¡µæ‰“å¼€é€‰é¡¹
                const openItem = document.createElement('div');
                openItem.className = 'image-context-menu-item';
                openItem.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    <span>æ–°æ ‡ç­¾é¡µæ‰“å¼€</span>
                `;
                openItem.onclick = () => {
                    window.open(imageUrl, '_blank');
                    menu.remove();
                };

                menu.appendChild(copyItem);
                menu.appendChild(openItem);
                document.body.appendChild(menu);

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                setTimeout(() => {
                    document.addEventListener('click', closeMenu);
                }, 0);
            }

            // å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿
            async copyImageToClipboard(imageUrl) {
                try {
                    // è·å–å›¾ç‰‡
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    
                    // å¤åˆ¶åˆ°å‰ªè´´æ¿
                    await navigator.clipboard.write([
                        new ClipboardItem({
                            [blob.type]: blob
                        })
                    ]);
                    
                    this.showSuccessMessage('å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (error) {
                    console.error('å¤åˆ¶å›¾ç‰‡å¤±è´¥:', error);
                    // å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œå°è¯•å¤åˆ¶å›¾ç‰‡URL
                    try {
                        await navigator.clipboard.writeText(imageUrl);
                        this.showSuccessMessage('å›¾ç‰‡URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    } catch (urlError) {
                        this.showErrorMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶å›¾ç‰‡');
                    }
                }
            }

            showToast(message, backgroundColor) {
                // ä½¿ç”¨æ›´ä¼˜é›…çš„æ–¹å¼æ˜¾ç¤ºæ¶ˆæ¯ï¼Œè€Œä¸æ˜¯alert
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${backgroundColor};
                    color: #F9FBFC;
                    padding: 12px 20px;
                    border-radius: 0;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    max-width: 400px;
                    text-align: center;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 3000);
            }

            updateApiStatus(connected, errorMessage = '') {
                const status = document.getElementById('connectionStatus');
                if (connected) {
                    status.textContent = 'API å·²è¿æ¥';
                    status.className = 'connection-status connected';
                } else {
                    status.textContent = 'API è¿æ¥å¤±è´¥';
                    status.className = 'connection-status disconnected';
                    status.title = errorMessage;
                }
            }

            async submitSingle() {
                console.log('submitSingle å‡½æ•°è¢«è°ƒç”¨');
                
                // ğŸ¯ ç«‹å³åˆ›å»ºä¸´æ—¶ä»»åŠ¡ï¼Œæ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ï¼ˆæå‡å“åº”ä½“éªŒï¼‰
                const tempTaskId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const workflowType = document.getElementById('workflowType').value;
                
                // æ„å»ºè¯·æ±‚å‚æ•°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                const request = {
                    workflow_type: workflowType,
                    prompt: document.getElementById('prompt').value,
                    negative_prompt: document.getElementById('negativePrompt').value,
                    width: parseInt(document.getElementById('width').value),
                    height: parseInt(document.getElementById('height').value),
                    steps: parseInt(document.getElementById('steps').value),
                    cfg: parseFloat(document.getElementById('cfg').value),
                    seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null,
                    batch_size: parseInt(document.getElementById('batchSize').value),
                    batch_name: null,
                    input_image: null
                };
                
                // ç«‹å³æ·»åŠ ä¸´æ—¶ä»»åŠ¡åˆ°åˆ—è¡¨
                this.tasks[tempTaskId] = {
                    task_id: tempTaskId,
                    status: 'generating',
                    request_data: request,
                    created_at: new Date().toISOString(),
                    result_urls: null,
                    completed_at: null
                };
                this.updateTaskList();
                console.log('âœ… ç«‹å³æ˜¾ç¤ºä¸´æ—¶ä»»åŠ¡:', tempTaskId);
                
                try {
                // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
                const imageFile = document.getElementById('inputImage').files[0];
                let inputImageName = null;
                
                if (imageFile) {
                    // å¦‚æœæœ‰ä¸Šä¼ å›¾ç‰‡ï¼Œå…ˆä¸Šä¼ å›¾ç‰‡
                    const formData = new FormData();
                    formData.append('file', imageFile);
                    
                    try {
                        const uploadResult = await fetch(`${this.apiServer}/upload_image`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (uploadResult.ok) {
                            const uploadData = await uploadResult.json();
                            inputImageName = uploadData.filename;
                        } else {
                            throw new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                        }
                    } catch (error) {
                            // ç§»é™¤ä¸´æ—¶ä»»åŠ¡
                            delete this.tasks[tempTaskId];
                            this.updateTaskList();
                        this.showErrorMessage(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`);
                        return;
                    }
                }
                
                    request.input_image = inputImageName;

                    // Qwen å›¾ç”Ÿå›¾æ”¯æŒå¤šå¼ è¾“å…¥å›¾ç‰‡
                    if (workflowType === 'qwen_img2img') {
                        // å°è¯•ä¸Šä¼ ç¬¬2å¼ å’Œç¬¬3å¼ å›¾ç‰‡
                        const inputImage2 = document.getElementById('inputImage2').files[0];
                        const inputImage3 = document.getElementById('inputImage3').files[0];
                        
                        if (inputImage2) {
                            try {
                                const formData2 = new FormData();
                                formData2.append('file', inputImage2);
                                const uploadResult2 = await fetch(`${this.apiServer}/upload_image`, {
                                    method: 'POST',
                                    body: formData2
                                });
                                if (uploadResult2.ok) {
                                    const uploadData2 = await uploadResult2.json();
                                    request.input_image2 = uploadData2.filename;
                                }
                } catch (error) {
                                console.warn('ç¬¬2å¼ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                            }
                        }
                        
                        if (inputImage3) {
                            try {
                                const formData3 = new FormData();
                                formData3.append('file', inputImage3);
                                const uploadResult3 = await fetch(`${this.apiServer}/upload_image`, {
                                    method: 'POST',
                                    body: formData3
                                });
                                if (uploadResult3.ok) {
                                    const uploadData3 = await uploadResult3.json();
                                    request.input_image3 = uploadData3.filename;
                                }
                            } catch (error) {
                                console.warn('ç¬¬3å¼ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                            }
                        }
                    }

                    console.log('ğŸš€ å¼€å§‹æäº¤ä»»åŠ¡');
                    
                    const result = await this.apiCall('/generate', 'POST', request, false); // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œæˆ‘ä»¬è‡ªå·±å¤„ç†
                    console.log('âœ… ä»»åŠ¡æäº¤æˆåŠŸï¼Œä»»åŠ¡ID:', result.task_id);
                    
                    // ç§»é™¤ä¸´æ—¶ä»»åŠ¡
                    delete this.tasks[tempTaskId];
                    
                    // ä¿å­˜å®Œæ•´ä»»åŠ¡ä¿¡æ¯ï¼ˆå‚æ•° + çŠ¶æ€ï¼‰
                    this.tasks[result.task_id] = {
                        task_id: result.task_id,
                        status: 'generating',
                        request_data: request,  // ğŸ¯ ç”¨æˆ·è¾“å…¥å‚æ•°ï¼ˆæ°¸ä¹…ä¿ç•™ï¼‰
                        created_at: new Date().toISOString(),
                        // ComfyUIç›¸å…³å­—æ®µç¨åæ›´æ–°
                        result_urls: null,
                        completed_at: null
                    };
                    
                    // ç«‹å³ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
                    this.saveTaskToLocalStorage(result.task_id, this.tasks[result.task_id]);
                    
                    console.log('âœ… æ›¿æ¢ä¸ºçœŸå®ä»»åŠ¡:', result.task_id);
                    this.updateTaskList();
                    
                    this.showSuccessMessage(`ä»»åŠ¡å·²æäº¤ï¼ä»»åŠ¡ID: ${result.task_id.substring(0, 8)}...`);
                    
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    this.pollTaskStatus(result.task_id);
                } catch (error) {
                    console.error('âŒ ä»»åŠ¡æäº¤å¤±è´¥:', error);
                    
                    // ç§»é™¤ä¸´æ—¶ä»»åŠ¡
                    delete this.tasks[tempTaskId];
                    this.updateTaskList();
                    
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    const errorMessage = error.message || 'ä»»åŠ¡æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•';
                    this.showErrorMessage(errorMessage);
                    
                    // æ¢å¤è‡ªåŠ¨åˆ·æ–°
                    this._manuallyPaused = false; // æ¸…é™¤æ‰‹åŠ¨æš‚åœæ ‡è®°
                    if (this.apiConnected) {
                        this.startRefreshTimer();
                    }
                }
            }

            async submitBatch() {
                // æ‰¹é‡åŠŸèƒ½å·²ç§»é™¤
                this.showErrorMessage('æ‰¹é‡åŠŸèƒ½æš‚ä¸å¯ç”¨');
                return;
            }

            // è½®è¯¢å•ä¸ªä»»åŠ¡çŠ¶æ€
            async pollTaskStatus(taskId, maxAttempts = 60) {
                let attempts = 0;
                const pollInterval = 2000; // 2ç§’è½®è¯¢ä¸€æ¬¡
                let consecutiveErrors = 0; // è¿ç»­é”™è¯¯è®¡æ•°
                const maxConsecutiveErrors = 5; // æœ€å¤šè¿ç»­5æ¬¡é”™è¯¯ååœæ­¢
                
                const poll = async () => {
                    try {
                        // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch(`${this.apiServer}/task/${taskId}`, {
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥`);
                        }
                        
                        const taskData = await response.json();
                        consecutiveErrors = 0; // é‡ç½®é”™è¯¯è®¡æ•°
                        
                        if (taskData.status === 'completed') {
                            // ä»»åŠ¡å®Œæˆï¼Œç«‹å³åˆ·æ–°è·å–å®Œæ•´æ•°æ®
                            console.log(`ğŸ‰ ä»»åŠ¡ ${taskId} å®Œæˆ`);
                            await this.refreshTasks();
                            this.showSuccessMessage('å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼');
                            return;
                        } else if (taskData.status === 'error') {
                            // ä»»åŠ¡å¤±è´¥
                            if (this.tasks[taskId]) {
                                this.tasks[taskId].status = 'failed';
                                this.updateTaskList();
                            }
                            this.showErrorMessage('å›¾ç‰‡ç”Ÿæˆå¤±è´¥');
                            return;
                        } else if (taskData.status === 'running' || taskData.status === 'pending') {
                            // æ›´æ–°çŠ¶æ€ä½†ä¿æŒloadingæ˜¾ç¤º
                            if (this.tasks[taskId]) {
                                const oldStatus = this.tasks[taskId].status;
                                this.tasks[taskId].status = taskData.status;
                                console.log(`ğŸ”„ ä»»åŠ¡ ${taskId} çŠ¶æ€å˜åŒ–: ${oldStatus} â†’ ${taskData.status}`);
                                this.updateTaskList();
                            }
                        }
                        
                        // ç»§ç»­è½®è¯¢
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(poll, pollInterval);
                        } else {
                            // è¶…æ—¶
                            console.warn(`â° ä»»åŠ¡ ${taskId} è½®è¯¢è¶…æ—¶`);
                            if (this.tasks[taskId]) {
                                this.tasks[taskId].status = 'failed';
                                this.tasks[taskId].error = 'ä»»åŠ¡è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€';
                                this.updateTaskList();
                            }
                            this.showErrorMessage('ä»»åŠ¡è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
                            await this.refreshTasks();
                        }
                    } catch (error) {
                        console.error('è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                        consecutiveErrors++;
                        
                        // å¦‚æœè¿ç»­å¤šæ¬¡å¤±è´¥ï¼Œå¯èƒ½æ˜¯APIå…³é—­äº†
                        if (consecutiveErrors >= maxConsecutiveErrors) {
                            console.warn(`âŒ ä»»åŠ¡ ${taskId} è¿ç»­${maxConsecutiveErrors}æ¬¡è½®è¯¢å¤±è´¥ï¼Œåœæ­¢è½®è¯¢`);
                            if (this.tasks[taskId]) {
                                this.tasks[taskId].status = 'failed';
                                this.tasks[taskId].error = 'APIè¿æ¥å¤±è´¥ï¼Œæ— æ³•è·å–ä»»åŠ¡çŠ¶æ€';
                                this.updateTaskList();
                            }
                            this.showErrorMessage('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œä»»åŠ¡çŠ¶æ€æœªçŸ¥');
                            return;
                        }
                        
                        // ç»§ç»­è½®è¯¢
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(poll, pollInterval);
                        } else {
                            // è¶…æ—¶
                            if (this.tasks[taskId]) {
                                this.tasks[taskId].status = 'failed';
                                this.tasks[taskId].error = 'ä»»åŠ¡è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€';
                                this.updateTaskList();
                            }
                            this.showErrorMessage('ä»»åŠ¡è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
                        }
                    }
                };
                
                // å¼€å§‹è½®è¯¢
                setTimeout(poll, pollInterval);
            }

            async refreshTasks() {
                try {
                    const result = await this.apiCall('/tasks');
                    
                    console.log('ğŸ”„ ä»ComfyUIè·å–æ‰§è¡Œä¿¡æ¯:', result.tasks.length, 'ä¸ªä»»åŠ¡');
                    
                    // è·å–ComfyUIè¿”å›çš„æ‰€æœ‰ä»»åŠ¡ID
                    const comfyTaskIds = new Set(result.tasks.map(task => task.task_id));
                    
                    // ğŸ¯ æ–°é€»è¾‘ï¼šåˆå¹¶æœ¬åœ°å‚æ•° + ComfyUIæ‰§è¡Œä¿¡æ¯
                    result.tasks.forEach(comfyTask => {
                        const taskId = comfyTask.task_id;
                        const localTask = this.tasks[taskId];
                        
                        if (localTask) {
                            // æœ¬åœ°æœ‰å‚æ•°ï¼Œåˆå¹¶ComfyUIçš„æ‰§è¡Œä¿¡æ¯
                            // ğŸ¯ å…³é”®ï¼šä¿ç•™è¿›åº¦æ¨¡æ‹Ÿæ•°æ®ï¼ˆprogress, progress_message, progressIntervalï¼‰
                            this.tasks[taskId] = {
                                ...localTask,                    // ğŸ¯ ä¿ç•™æœ¬åœ°å‚æ•°å’ŒçŠ¶æ€ï¼ˆåŒ…æ‹¬è¿›åº¦æ•°æ®ï¼‰
                                // åªæ›´æ–°ComfyUIæä¾›çš„æ‰§è¡Œä¿¡æ¯
                                status: comfyTask.status === 'completed' ? 'completed' : localTask.status,
                                result_urls: comfyTask.result_urls || localTask.result_urls,
                                completed_at: comfyTask.completed_at || localTask.completed_at,
                                images: comfyTask.images || localTask.images
                                // progress å’Œ progress_message é€šè¿‡ ...localTask è‡ªåŠ¨ä¿ç•™
                            };
                            
                            // å¦‚æœä»»åŠ¡å®Œæˆï¼Œä¿å­˜æ›´æ–°åˆ°localStorage
                            if (comfyTask.status === 'completed') {
                                this.saveTaskToLocalStorage(taskId, this.tasks[taskId]);
                                console.log('âœ… ä»»åŠ¡å®Œæˆï¼Œæ›´æ–°çŠ¶æ€:', taskId);
                            }
                        } else {
                            // æœ¬åœ°æ²¡æœ‰å‚æ•°ï¼ˆè€ä»»åŠ¡ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ComfyUIæ•°æ®
                            this.tasks[taskId] = comfyTask;
                            console.log('ğŸ“¥ æ·»åŠ ComfyUIå†å²ä»»åŠ¡:', taskId);
                        }
                    });
                    
                    // ğŸ¯ æ£€æŸ¥é•¿æ—¶é—´å¤„äºgeneratingçŠ¶æ€çš„ä»»åŠ¡ï¼ˆå¯èƒ½APIå…³é—­æ—¶åˆ›å»ºçš„ä»»åŠ¡ï¼‰
                    const now = Date.now();
                    Object.keys(this.tasks).forEach(taskId => {
                        const task = this.tasks[taskId];
                        // å¦‚æœä»»åŠ¡å¤„äºgeneratingçŠ¶æ€ï¼Œä½†ComfyUIæ²¡æœ‰è¿”å›è¿™ä¸ªä»»åŠ¡ï¼Œä¸”åˆ›å»ºæ—¶é—´è¶…è¿‡5åˆ†é’Ÿ
                        if (task.status === 'generating' && !comfyTaskIds.has(taskId)) {
                            const createdTime = new Date(task.created_at).getTime();
                            const elapsedMinutes = (now - createdTime) / (1000 * 60);
                            
                            if (elapsedMinutes > 5) {
                                console.warn(`âš ï¸ ä»»åŠ¡ ${taskId} é•¿æ—¶é—´å¤„äºgeneratingçŠ¶æ€ï¼Œæ ‡è®°ä¸ºå¤±è´¥`);
                                task.status = 'failed';
                                task.error = 'ä»»åŠ¡å¯èƒ½æœªæˆåŠŸæäº¤åˆ°æœåŠ¡å™¨';
                                this.updateTaskList();
                            }
                        }
                    });
                    
                    this.updateTaskList();
                    this.updateStats();
                    this.updateTaskMonitorTitle();
                } catch (error) {
                    console.error('åˆ·æ–°ä»»åŠ¡å¤±è´¥:', error);
                    // å³ä½¿åˆ·æ–°å¤±è´¥ï¼Œä¹Ÿæ£€æŸ¥é•¿æ—¶é—´å¤„äºgeneratingçŠ¶æ€çš„ä»»åŠ¡
                    const now = Date.now();
                    Object.keys(this.tasks).forEach(taskId => {
                        const task = this.tasks[taskId];
                        if (task.status === 'generating') {
                            const createdTime = new Date(task.created_at).getTime();
                            const elapsedMinutes = (now - createdTime) / (1000 * 60);
                            
                            if (elapsedMinutes > 10) {
                                console.warn(`âš ï¸ ä»»åŠ¡ ${taskId} é•¿æ—¶é—´å¤„äºgeneratingçŠ¶æ€ä¸”æ— æ³•åˆ·æ–°ï¼Œæ ‡è®°ä¸ºå¤±è´¥`);
                                task.status = 'failed';
                                task.error = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œä»»åŠ¡çŠ¶æ€æœªçŸ¥';
                                this.updateTaskList();
                            }
                        }
                    });
                }
            }

            updateTask(taskData) {
                const taskId = taskData.task_id;
                const existingTask = this.tasks[taskId];
                
                // å¦‚æœå­˜åœ¨æœ¬åœ°ä»»åŠ¡ï¼Œä¿ç•™å…¶ request_data
                if (existingTask && existingTask.request_data) {
                    console.log('ğŸ” updateTask - ä¿ç•™æœ¬åœ°å‚æ•°:', taskId, existingTask.request_data);
                    this.tasks[taskId] = {
                        ...taskData,
                        request_data: existingTask.request_data  // ä¿ç•™æœ¬åœ°å‚æ•°
                    };
                } else {
                    this.tasks[taskId] = taskData;
                }
                
                this.updateTaskList();
                this.updateStats();
                this.updateTaskMonitorTitle();
            }

            updateTaskList() {
                const taskList = document.getElementById('taskList');
                
                // è°ƒè¯•ï¼šæ‰“å°æ‰€æœ‰ä»»åŠ¡çŠ¶æ€
                const allTasks = Object.values(this.tasks);
                const generatingTasksBefore = allTasks.filter(t => t.status === 'generating');
                console.log('ğŸ” è¿‡æ»¤å‰ - å½“å‰æ‰€æœ‰ä»»åŠ¡æ•°é‡:', allTasks.length);
                console.log('ğŸ” è¿‡æ»¤å‰ - generating çŠ¶æ€ä»»åŠ¡:', generatingTasksBefore.map(t => ({ id: t.task_id, status: t.status, created_at: t.created_at })));
                console.log('ğŸ” å½“å‰ viewMode:', this.viewMode);
                
                // æ ¹æ®viewModeè¿‡æ»¤ä»»åŠ¡
                let filteredTasks = Object.values(this.tasks).filter(task => {
                    if (this.viewMode === 'completed') {
                        return task.status === 'completed';
                    } else if (this.viewMode === 'failed') {
                        return task.status === 'failed';
                    }
                    return true; // 'all' æˆ–å…¶ä»–å€¼ï¼šæ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€ï¼ŒåŒ…æ‹¬ generating, running, completed, failed
                });
                
                console.log('ğŸ” è¿‡æ»¤åï¼ˆæ’åºå‰ï¼‰ä»»åŠ¡æ•°é‡:', filteredTasks.length);
                console.log('ğŸ” è¿‡æ»¤åï¼ˆæ’åºå‰ï¼‰generating çŠ¶æ€ä»»åŠ¡:', filteredTasks.filter(t => t.status === 'generating').map(t => ({ id: t.task_id, status: t.status })));
                
                // æ’åº
                filteredTasks = filteredTasks.sort((a, b) => {
                    // ç¡®ä¿æœ‰ created_at æ‰æ’åºï¼Œæ²¡æœ‰çš„æ”¾åœ¨æœ€å
                    const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
                    const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                    return dateB - dateA; // é™åºï¼šæœ€æ–°çš„åœ¨ä¸Šé¢
                });
                
                console.log('ğŸ” æ’åºåä»»åŠ¡æ•°é‡:', filteredTasks.length);
                console.log('ğŸ” æ’åºå generating çŠ¶æ€ä»»åŠ¡:', filteredTasks.filter(t => t.status === 'generating').map(t => ({ id: t.task_id, status: t.status, created_at: t.created_at })));
                console.log('è¿‡æ»¤åçš„ä»»åŠ¡æ•°é‡:', filteredTasks.length);
                console.log('generating çŠ¶æ€çš„ä»»åŠ¡:', filteredTasks.filter(t => t.status === 'generating').length);
                console.log('running çŠ¶æ€çš„ä»»åŠ¡:', filteredTasks.filter(t => t.status === 'running').length);

                if (filteredTasks.length === 0) {
                    const emptyMessage = this.viewMode === 'failed' 
                        ? 'æš‚æ— å¤±è´¥ä»»åŠ¡' 
                        : 'æš‚æ— ä»»åŠ¡';
                    taskList.innerHTML = `<div style="text-align: center; padding: 50px; color: #757575;">${emptyMessage}</div>`;
                    return;
                }

                taskList.innerHTML = filteredTasks.map(task => {
                    // è®¡ç®—ç”¨æ—¶
                    let duration = '';
                    if (task.created_at && task.completed_at) {
                        const start = new Date(task.created_at);
                        const end = new Date(task.completed_at);
                        const seconds = Math.round((end - start) / 1000);
                        duration = seconds;
                    }

                    // æ ¼å¼åŒ–æ—¥æœŸä¸º 2025/11/7 æ ¼å¼
                    const formatDate = (dateString) => {
                        const date = new Date(dateString);
                        const year = date.getFullYear();
                        const month = date.getMonth() + 1;
                        const day = date.getDate();
                        return `${year}/${month}/${day}`;
                    };

                    return `
                    <div class="task-item">
                        <div class="task-header">
                            <div class="task-header-left"></div>
                            <div class="task-header-right"></div>
                        </div>
                        
                        <div class="task-details">
                            ${task.error ? `<div style="color: #f44336;"><strong>é”™è¯¯:</strong> ${task.error}</div>` : ''}
                            ${this.renderResultImages(task, duration)}
                        </div>
                    </div>
                    `;
                }).join('');
                
                // å¤„ç†å·²åŠ è½½çš„å›¾ç‰‡ï¼ˆä»ç¼“å­˜ä¸­åŠ è½½çš„ï¼Œä¸ä¼šè§¦å‘onloadï¼‰
                setTimeout(() => {
                    const images = taskList.querySelectorAll('.image-grid-item img');
                    images.forEach(img => {
                        if (img.complete && !img.hasAttribute('data-loaded')) {
                            img.style.opacity = '1';
                            img.setAttribute('data-loaded', 'true');
                        }
                    });
                }, 50);
                
                // åŒæ­¥å‚æ•°ä¿¡æ¯åŒºåŸŸé«˜åº¦ä¸å›¾ç‰‡åŒºåŸŸé«˜åº¦
                this.syncParamsHeight();
            }

            renderResultImages(task, duration = '') {
                const taskId = task.task_id || '';
                const taskStatus = task.status || 'unknown';
                
                // Render result images based on task status
                
                // ç”Ÿæˆä¸­çŠ¶æ€ï¼ˆåŒ…æ‹¬ generatingã€running å’Œ pendingï¼‰
                if (task.status === 'generating' || task.status === 'running' || task.status === 'pending') {
                    console.log(`ğŸ”„ ä»»åŠ¡ ${taskId} æ˜¾ç¤ºloading, çŠ¶æ€: ${task.status}`);
                    return `
                        <div>
                            ${this.renderPromptOnly(task)}
                            <div class="result-container">
                                <div class="image-grid" style="display: flex; align-items: center; justify-content: center; min-height: 500px; max-height: 600px;">
                                    <div class="loading-spinner">
                                        <div class="spinner"></div>
                                        <div style="margin-top: 20px; color: #80A5A0; font-size: 0.9rem;">å›¾ç‰‡ç”Ÿæˆä¸­</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // æ”¯æŒå¤šå¼ å›¾ç‰‡æ˜¾ç¤º
                if (task.result_urls && task.result_urls.length > 0) {
                    // æ£€æµ‹æ˜¯å¦æ˜¯1:1æ¯”ä¾‹çš„å››å¼ å›¾ç‰‡
                    const isSquare4Images = task.result_urls.length === 4 && 
                                           task.request_data && 
                                           task.request_data.width === task.request_data.height;
                    
                    // æ ¹æ®æƒ…å†µæ·»åŠ ä¸åŒçš„class
                    const gridClass = isSquare4Images ? 'image-grid image-grid-4x1' : 'image-grid';
                    
                    // å¤šå¼ å›¾ç‰‡æ¨¡å¼ - å®«æ ¼å¸ƒå±€
                    // å¦‚æœæ˜¯1:1æ¯”ä¾‹çš„å››å¼ å›¾ç‰‡ï¼Œä½¿ç”¨ç‰¹æ®Šçš„æ ·å¼
                    const imageItemStyle = isSquare4Images 
                        ? "max-width: 100%; box-sizing: border-box; padding: 0; margin: 0; position: relative; aspect-ratio: 1;"
                        : "min-height: 500px; max-height: 100%; max-width: 100%; box-sizing: border-box;";
                    const imageStyle = isSquare4Images
                        ? "width: 100% !important; height: 100% !important; max-width: 100% !important; max-height: 100% !important; object-fit: contain !important; object-position: center; display: block; opacity: 0; box-sizing: border-box; position: absolute; top: 0; left: 0;"
                        : "max-width: 100% !important; max-height: 100% !important; width: auto; height: auto; object-fit: contain; display: block; opacity: 0; box-sizing: border-box;";
                    
                    const imagesHtml = task.result_urls.map((url, index) => `
                        <div class="image-grid-item" onclick="event.stopPropagation(); manager.previewTaskDetail('${taskId}', ${index})" style="${imageItemStyle}">
                            <img src="${url}" 
                                 alt="ç”Ÿæˆç»“æœ ${index + 1}" 
                                 loading="lazy"
                                 style="${imageStyle}"
                                 onload="this.style.opacity='1'; this.setAttribute('data-loaded', 'true');">
                        </div>
                    `).join('');
                    
                    // 4å¼ å›¾ç‰‡æ—¶ï¼Œå®¹å™¨ä¸æ˜¾ç¤ºèƒŒæ™¯ï¼Œåªä¿ç•™ç‚¹å‡»åŠŸèƒ½
                    const containerClass = isSquare4Images ? 'result-container image-container-4x1' : 'result-container';
                    return `
                        <div>
                            ${this.renderPromptOnly(task)}
                            <div class="${containerClass}" onclick="manager.previewTaskDetail('${taskId}', 0)">
                                <div class="${gridClass}" style="${isSquare4Images ? 'min-height: 200px; height: auto;' : 'min-height: 500px; max-height: 600px;'}">
                                    ${imagesHtml}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (task.result_url) {
                    // å•å¼ å›¾ç‰‡æ¨¡å¼ï¼ˆå‘åå…¼å®¹ï¼‰- ä¹Ÿä½¿ç”¨å®«æ ¼æ ·å¼
                    return `
                        <div>
                            ${this.renderPromptOnly(task)}
                            <div class="result-container" onclick="manager.previewTaskDetail('${taskId}')">
                                <div class="image-grid" style="min-height: 500px; max-height: 600px;">
                                    <div class="image-grid-item" style="min-height: 500px; max-height: 100%; max-width: 100%; box-sizing: border-box;">
                                        <img src="${task.result_url}" 
                                             alt="ç”Ÿæˆç»“æœ" 
                                             loading="lazy"
                                             style="max-width: 100% !important; max-height: 100% !important; width: auto; height: auto; object-fit: contain; display: block; opacity: 0; box-sizing: border-box;"
                                             onload="this.style.opacity='1'; this.setAttribute('data-loaded', 'true');">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // æ²¡æœ‰å›¾ç‰‡çš„æƒ…å†µï¼ˆå¦‚å¤±è´¥ä»»åŠ¡ï¼‰ï¼Œæ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
                    console.log(`âŒ ä»»åŠ¡ ${taskId} æ˜¾ç¤ºæ— å›¾ç‰‡, çŠ¶æ€: ${task.status}, æœ‰result_urls: ${!!task.result_urls}, æœ‰result_url: ${!!task.result_url}`);
                    
                    // æ ¹æ®ä»»åŠ¡çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æç¤ºä¿¡æ¯
                    let statusMessage = 'æ— å›¾ç‰‡';
                    let statusColor = '#757575';
                    if (task.status === 'failed') {
                        statusMessage = task.error || 'ç”Ÿæˆå¤±è´¥';
                        statusColor = '#dc3545';
                    } else if (task.status === 'completed' && !task.result_url && !task.result_urls) {
                        statusMessage = 'æ— å›¾ç‰‡';
                        statusColor = '#757575';
                    }
                    
                    return `
                        <div>
                            ${this.renderPromptOnly(task)}
                            <div class="result-container">
                                <div class="image-grid" style="display: flex; align-items: center; justify-content: center; min-height: 500px; max-height: 600px;">
                                    <div style="color: ${statusColor}; font-size: 0.9rem; text-align: center;">
                                        <div style="margin-bottom: 10px; font-size: 1.2rem;">${task.status === 'failed' ? 'âŒ' : 'ğŸ“­'}</div>
                                        <div>${statusMessage}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // åªæ¸²æŸ“æç¤ºè¯ï¼ˆç”¨äºå›¾ç‰‡åˆ—è¡¨ï¼‰
            renderPromptOnly(task) {
                const params = task.request_data || {};
                return `
                    <div class="prompt-only">
                        ${params.prompt ? `
                            <div class="prompt-text">${this.escapeHtml(params.prompt)}</div>
                        ` : '<div class="prompt-text" style="color: #666;">æ— æç¤ºè¯</div>'}
                    </div>
                `;
            }

            renderGenerationParams(task, duration = '') {
                // æ ¼å¼åŒ–åˆ›å»ºæ—¶é—´ä¸ºå…·ä½“æ—¶é—´ï¼ˆåŒ…æ‹¬æ—¶åˆ†ç§’ï¼‰
                const formatDateTime = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
                };

                const createdDateTime = formatDateTime(task.created_at);
                const taskId = task.task_id || '';
                const params = task.request_data || {};
                
                // è°ƒè¯•ï¼šæ£€æŸ¥å‚æ•°æ•°æ®
                console.log('ğŸ¨ æ¸²æŸ“å‚æ•° - ä»»åŠ¡:', taskId, 'çŠ¶æ€:', task.status, 'å‚æ•°:', params);
                
                return `
                    <div class="generation-params" onclick="event.stopPropagation(); manager.previewTaskDetail('${taskId}')" style="cursor: pointer;">
                        <div class="params-content">
                            ${params.prompt ? `
                                <div class="param-item">
                                    <div class="param-label">æç¤ºè¯ï¼š</div>
                                    <div class="param-value">${this.escapeHtml(params.prompt)}</div>
                                </div>
                            ` : ''}
                            ${params.negative_prompt ? `
                                <div class="param-item">
                                    <div class="param-label">è´Ÿé¢æç¤ºè¯ï¼š</div>
                                    <div class="param-value">${this.escapeHtml(params.negative_prompt)}</div>
                                </div>
                            ` : ''}
                            ${duration ? `
                                <div class="param-item-inline" style="margin-bottom: 10px;">
                                    <span class="param-label">ç”¨æ—¶ï¼š</span>
                                    <span class="param-value">${duration}ç§’</span>
                                </div>
                            ` : ''}
                            ${params.width && params.height ? `
                                <div class="param-row">
                                    <div class="param-item-inline">
                                        <span class="param-label">å°ºå¯¸ï¼š</span>
                                        <span class="param-value">${params.width}Ã—${params.height}</span>
                                    </div>
                                    ${params.steps ? `
                                        <div class="param-item-inline">
                                            <span class="param-label">æ­¥æ•°ï¼š</span>
                                            <span class="param-value">${params.steps}</span>
                                        </div>
                                    ` : ''}
                                    ${params.cfg ? `
                                        <div class="param-item-inline">
                                            <span class="param-label">CFGï¼š</span>
                                            <span class="param-value">${params.cfg}</span>
                                        </div>
                                    ` : ''}
                                    ${params.seed ? `
                                        <div class="param-item-inline">
                                            <span class="param-label">ç§å­ï¼š</span>
                                            <span class="param-value">${params.seed}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            ${taskId ? `
                                <div class="param-item-inline" style="margin-bottom: 10px;">
                                    <span class="param-label">ä»»åŠ¡IDï¼š</span>
                                    <span class="param-value" style="font-family: monospace; color: #80A5A0;">${taskId}</span>
                                </div>
                            ` : ''}
                            ${createdDateTime ? `
                                <div class="param-item-inline" style="margin-bottom: 10px;">
                                    <span class="param-label">åˆ›å»ºæ—¶é—´ï¼š</span>
                                    <span class="param-value">${createdDateTime}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            updateStats() {
                const tasks = Object.values(this.tasks);
                
                document.getElementById('totalTasks').textContent = tasks.length;
                document.getElementById('runningTasks').textContent = tasks.filter(t => t.status === 'running' || t.status === 'generating' || t.status === 'pending').length;
                
                // å¦‚æœå¼¹çª—æ‰“å¼€ï¼ŒåŒæ­¥æ›´æ–°å¼¹çª—ä¸­çš„ç»Ÿè®¡æ•°æ®
                const statsModal = document.getElementById('statsModal');
                if (statsModal && statsModal.style.display === 'flex') {
                    updateStatsModal();
                }
                document.getElementById('completedTasks').textContent = tasks.filter(t => t.status === 'completed').length;
                
                const failedCount = tasks.filter(t => t.status === 'failed').length;
                const failedTasksElement = document.getElementById('failedTasks');
                failedTasksElement.textContent = failedCount;
                
                // ç»™å¤±è´¥æ•°å­—æ·»åŠ ç‚¹å‡»äº‹ä»¶
                if (failedCount > 0) {
                    failedTasksElement.style.cursor = 'pointer';
                    failedTasksElement.style.textDecoration = 'underline';
                    failedTasksElement.onclick = () => {
                        this.switchToFailedView();
                    };
                } else {
                    failedTasksElement.style.cursor = 'default';
                    failedTasksElement.style.textDecoration = 'none';
                    failedTasksElement.onclick = null;
                }
            }

            switchToFailedView() {
                this.viewMode = 'failed';
                this.updateTaskList();
                // æ›´æ–°ä»»åŠ¡ç›‘æ§æ ‡é¢˜ï¼Œæ˜¾ç¤ºå½“å‰è§†å›¾
                this.updateTaskMonitorTitle();
            }

            switchToCompletedView() {
                this.viewMode = 'completed';
                this.updateTaskList();
                this.updateTaskMonitorTitle();
            }

            updateTaskMonitorTitle() {
                const taskMonitorTitle = document.querySelector('.monitoring-header');
                if (taskMonitorTitle) {
                    const collapseArrow = taskMonitorTitle.querySelector('.collapse-arrow');
                    const arrowHtml = collapseArrow ? collapseArrow.outerHTML : '';
                    
                    if (this.viewMode === 'failed') {
                        taskMonitorTitle.innerHTML = `ä»»åŠ¡ç›‘æ§ <span style="font-size: 14px; color: #f44336; margin-left: 10px; cursor: pointer; text-decoration: underline;" onclick="event.stopPropagation(); manager.switchToCompletedView()">è¿”å›æˆåŠŸåˆ—è¡¨</span> ${arrowHtml}`;
                        // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                        taskMonitorTitle.setAttribute('onclick', 'toggleTaskStats()');
                    } else {
                        taskMonitorTitle.innerHTML = `ä»»åŠ¡ç›‘æ§ ${arrowHtml}`;
                        // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                        taskMonitorTitle.setAttribute('onclick', 'toggleTaskStats()');
                    }
                }
            }

            getStatusText(status) {
                const statusMap = {
                    'pending': 'ç­‰å¾…ä¸­',
                    'running': 'ç”Ÿæˆä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'failed': 'å¤±è´¥'
                };
                return statusMap[status] || status;
            }

            clearCompleted() {
                // åˆ›å»ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†ï¼Œè€Œä¸ä½¿ç”¨ç³»ç»Ÿconfirm
                if (this.showConfirmDialog('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²å®Œæˆå’Œå¤±è´¥çš„ä»»åŠ¡å—ï¼Ÿ')) {
                    const activeTasks = {};
                    Object.values(this.tasks).forEach(task => {
                        if (task.status === 'pending' || task.status === 'running') {
                            activeTasks[task.task_id] = task;
                        }
                    });
                    
                    this.tasks = activeTasks;
                    this.updateTaskList();
                    this.updateStats();
                    this.showSuccessMessage('å·²æ¸…é™¤å®Œæˆå’Œå¤±è´¥çš„ä»»åŠ¡');
                }
            }

            showConfirmDialog(message) {
                return confirm(message); // ä¿æŒç®€å•çš„confirmï¼Œå› ä¸ºè¿™æ˜¯ç”¨æˆ·ä¸»åŠ¨æ“ä½œ
            }

            // ä¸‹è½½å›¾ç‰‡åŠŸèƒ½
            downloadImage(imageUrl, filename) {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = filename || 'generated-image.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // é¢„è§ˆå›¾ç‰‡ï¼ˆæ¨¡æ€æ¡†ï¼‰
            previewImage(imageUrl) {
                const modal = document.getElementById('imageModal');
                const modalImg = document.getElementById('modalImage');
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                modal.style.display = 'block';
                
                // ğŸ¯ é˜²æ­¢é—ªç°ï¼šå…ˆéšè—å›¾ç‰‡å¹¶è®¾ç½®å°ºå¯¸é™åˆ¶
                modalImg.style.opacity = '0';
                modalImg.style.display = 'block';
                modalImg.style.maxWidth = '95vw';
                modalImg.style.maxHeight = '95vh';
                modalImg.style.width = 'auto';
                modalImg.style.height = 'auto';
                modalImg.style.objectFit = 'contain';
                
                // é‡ç½®è£å‰ªæ ·å¼
                modalImg.style.clipPath = 'none';
                
                // å…ˆè®¾ç½®å›¾ç‰‡æº
                modalImg.src = imageUrl;
                
                // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆåè¿›è¡Œè£å‰ªå¹¶æ˜¾ç¤º
                const showImage = () => {
                    this.cropWhiteBackground(modalImg);
                    modalImg.style.opacity = '1';
                };
                
                if (modalImg.complete) {
                    showImage();
                } else {
                    modalImg.onload = showImage;
                }
            }
            
            // è‡ªåŠ¨è£å‰ªç™½è‰²èƒŒæ™¯
            cropWhiteBackground(img) {
                try {
                    // å¦‚æœå›¾ç‰‡æ¥è‡ªä¸åŒæºï¼Œå¯èƒ½æ— æ³•è¯»å–åƒç´ æ•°æ®
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // æ£€æµ‹ç™½è‰²è¾¹ç¼˜çš„é˜ˆå€¼ï¼ˆRGBå€¼éƒ½å¤§äº240è®¤ä¸ºæ˜¯ç™½è‰²ï¼‰
                    const whiteThreshold = 240;
                    let minX = canvas.width;
                    let minY = canvas.height;
                    let maxX = 0;
                    let maxY = 0;
                    
                    // æ‰«æå›¾ç‰‡æ‰¾åˆ°éç™½è‰²åŒºåŸŸçš„è¾¹ç•Œ
                    for (let y = 0; y < canvas.height; y++) {
                        for (let x = 0; x < canvas.width; x++) {
                            const idx = (y * canvas.width + x) * 4;
                            const r = data[idx];
                            const g = data[idx + 1];
                            const b = data[idx + 2];
                            const a = data[idx + 3];
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºéç™½è‰²åƒç´ ï¼ˆè€ƒè™‘é€æ˜åº¦ï¼‰
                            if (a > 0 && (r < whiteThreshold || g < whiteThreshold || b < whiteThreshold)) {
                                if (x < minX) minX = x;
                                if (x > maxX) maxX = x;
                                if (y < minY) minY = y;
                                if (y > maxY) maxY = y;
                            }
                        }
                    }
                    
                    // å¦‚æœæ‰¾åˆ°äº†æœ‰æ•ˆåŒºåŸŸï¼Œåº”ç”¨è£å‰ª
                    if (minX < maxX && minY < maxY) {
                        const padding = 5; // æ·»åŠ å°‘é‡å†…è¾¹è·
                        minX = Math.max(0, minX - padding);
                        minY = Math.max(0, minY - padding);
                        maxX = Math.min(canvas.width, maxX + padding);
                        maxY = Math.min(canvas.height, maxY + padding);
                        
                        // è®¡ç®—è£å‰ªæ¯”ä¾‹
                        const cropLeft = minX / canvas.width;
                        const cropTop = minY / canvas.height;
                        const cropRight = maxX / canvas.width;
                        const cropBottom = maxY / canvas.height;
                        
                        // ä½¿ç”¨ clip-path è£å‰ªå›¾ç‰‡
                        img.style.clipPath = `inset(${cropTop * 100}% ${(1 - cropRight) * 100}% ${(1 - cropBottom) * 100}% ${cropLeft * 100}%)`;
                        
                        // è°ƒæ•´å›¾ç‰‡å°ºå¯¸ä»¥åŒ¹é…è£å‰ªåçš„åŒºåŸŸ
                        const cropWidth = maxX - minX;
                        const cropHeight = maxY - minY;
                        
                        // æ£€æŸ¥æ˜¯å¦åœ¨ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡†ä¸­
                        const isTaskDetail = img.closest('.task-detail-left');
                        let maxDisplayWidth, maxDisplayHeight;
                        
                        if (isTaskDetail) {
                            // ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡†ï¼šå›¾ç‰‡æœ€å¤§60vwï¼Œé«˜åº¦80vh
                            maxDisplayWidth = window.innerWidth * 0.6;
                            maxDisplayHeight = window.innerHeight * 0.8;
                        } else {
                            // å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†ï¼š95vw x 95vh
                            maxDisplayWidth = window.innerWidth * 0.95;
                            maxDisplayHeight = window.innerHeight * 0.95;
                        }
                        
                        if (cropWidth / cropHeight > maxDisplayWidth / maxDisplayHeight) {
                            img.style.width = maxDisplayWidth + 'px';
                            img.style.height = 'auto';
                        } else {
                            img.style.width = 'auto';
                            img.style.height = maxDisplayHeight + 'px';
                        }
                    }
                } catch (e) {
                    // å¦‚æœè·¨åŸŸæˆ–å…¶ä»–é”™è¯¯ï¼Œä¿æŒåŸæ ·æ˜¾ç¤º
                    console.warn('è£å‰ªç™½è‰²èƒŒæ™¯å¤±è´¥ï¼Œä½¿ç”¨åŸå›¾æ˜¾ç¤º:', e);
                }
            }

            // é¢„è§ˆä»»åŠ¡è¯¦æƒ…ï¼ˆåŒ…å«å›¾ç‰‡å’Œå‚æ•°ï¼‰
            previewTaskDetail(taskId, imageIndex = 0) {
                const task = this.tasks[taskId];
                if (!task) return;

                // è®¾ç½®å½“å‰å›¾ç‰‡ç´¢å¼•
                if (task.result_urls && task.result_urls.length > 0) {
                    // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
                    this.currentImageIndex = Math.max(0, Math.min(imageIndex || 0, task.result_urls.length - 1));
                } else {
                    this.currentImageIndex = 0;
                }

                // æ¸²æŸ“é¢„è§ˆåˆ—è¡¨
                this.renderPreviewList(taskId);

                // æ¸²æŸ“å½“å‰ä»»åŠ¡çš„è¯¦æƒ…
                this.renderTaskDetail(taskId);

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modal = document.getElementById('taskDetailModal');
                modal.style.display = 'flex';

                // æ·»åŠ é”®ç›˜å’Œé¼ æ ‡æ»šè½®äº‹ä»¶ç›‘å¬
                this.setupTaskNavigation(taskId);
            }

            // è®¾ç½®ä»»åŠ¡å¯¼èˆªï¼ˆé”®ç›˜å’Œé¼ æ ‡æ»šè½®ï¼‰
            setupTaskNavigation(currentTaskId) {
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                if (this.taskNavigationHandler) {
                    document.removeEventListener('keydown', this.taskNavigationHandler);
                }
                if (this.taskWheelHandler) {
                    const modal = document.getElementById('taskDetailModal');
                    modal.removeEventListener('wheel', this.taskWheelHandler);
                }

                // åˆ‡æ¢ä»»åŠ¡å‡½æ•°
                const switchTask = (direction) => {
                    // è·å–æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡åˆ—è¡¨
                    const completedTasks = Object.values(this.tasks).filter(task => 
                        task.status === 'completed' && (task.result_url || (task.result_urls && task.result_urls.length > 0))
                    ).sort((a, b) => {
                        const timeA = new Date(a.created_at || 0).getTime();
                        const timeB = new Date(b.created_at || 0).getTime();
                        return timeB - timeA;
                    });

                    if (completedTasks.length === 0) return;

                    // è·å–å½“å‰æ¿€æ´»çš„ä»»åŠ¡ID
                    const activeItem = document.querySelector('.preview-item.active');
                    let currentTaskId = null;
                    if (activeItem) {
                        const onclick = activeItem.getAttribute('onclick');
                        const match = onclick && onclick.match(/'([^']+)'/);
                        if (match) {
                            currentTaskId = match[1];
                        }
                    }

                    // å¦‚æœæ‰¾ä¸åˆ°å½“å‰ä»»åŠ¡ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªä»»åŠ¡
                    if (!currentTaskId && completedTasks.length > 0) {
                        currentTaskId = completedTasks[0].task_id;
                    }

                    // æ‰¾åˆ°å½“å‰ä»»åŠ¡çš„ç´¢å¼•
                    const currentIndex = completedTasks.findIndex(task => task.task_id === currentTaskId);
                    if (currentIndex === -1) return;

                    // è®¡ç®—æ–°ç´¢å¼•ï¼ˆä¸å¾ªç¯ï¼‰
                    let newIndex;
                    if (direction === 'next') {
                        newIndex = currentIndex + 1;
                        // å¦‚æœå·²ç»æ˜¯æœ€åä¸€å¼ ï¼Œä¸åˆ‡æ¢
                        if (newIndex >= completedTasks.length) {
                            return;
                        }
                    } else {
                        newIndex = currentIndex - 1;
                        // å¦‚æœå·²ç»æ˜¯ç¬¬ä¸€å¼ ï¼Œä¸åˆ‡æ¢
                        if (newIndex < 0) {
                            return;
                        }
                    }

                    const newTask = completedTasks[newIndex];
                    if (newTask) {
                        // åˆ‡æ¢ä»»åŠ¡æ—¶ï¼Œé‡ç½®å›¾ç‰‡ç´¢å¼•ä¸º0
                        this.currentImageIndex = 0;
                        this.renderTaskDetail(newTask.task_id);
                        this.updatePreviewActive(newTask.task_id);
                    }
                };

                // é”®ç›˜äº‹ä»¶å¤„ç†
                this.taskNavigationHandler = (event) => {
                    const modal = document.getElementById('taskDetailModal');
                    if (modal.style.display !== 'flex') return;

                    // ESCé”®å…³é—­æ¨¡æ€æ¡†
                    if (event.key === 'Escape') {
                        closeTaskDetailModal();
                        return;
                    }

                    // è·å–å½“å‰ä»»åŠ¡
                    const activeItem = document.querySelector('.preview-item.active');
                    let currentTaskId = null;
                    if (activeItem) {
                        const onclick = activeItem.getAttribute('onclick');
                        const match = onclick && onclick.match(/'([^']+)'/);
                        if (match) {
                            currentTaskId = match[1];
                        }
                    }
                    
                    if (!currentTaskId) return;
                    const currentTask = this.tasks[currentTaskId];
                    if (!currentTask) return;

                    // å·¦å³ç®­å¤´é”®ï¼šåˆ‡æ¢å½“å‰ä»»åŠ¡çš„å¤šå¼ å›¾ç‰‡ï¼ˆå¦‚æœæœ‰å¤šå¼ ï¼‰
                    if ((event.key === 'ArrowLeft' || event.key === 'ArrowRight') && 
                        currentTask.result_urls && currentTask.result_urls.length > 1) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        let newIndex = this.currentImageIndex;
                        if (event.key === 'ArrowLeft') {
                            newIndex = Math.max(0, newIndex - 1);
                        } else {
                            newIndex = Math.min(currentTask.result_urls.length - 1, newIndex + 1);
                        }
                        
                        if (newIndex !== this.currentImageIndex) {
                            this.switchToImage(newIndex, currentTaskId);
                        }
                        return;
                    }

                    // ä¸Šä¸‹ç®­å¤´é”®æˆ–å·¦å³é”®ï¼ˆå•å›¾ä»»åŠ¡ï¼‰ï¼šåˆ‡æ¢ä»»åŠ¡
                    if (event.key === 'ArrowUp' || event.key === 'ArrowDown' || 
                        ((event.key === 'ArrowLeft' || event.key === 'ArrowRight') && 
                         (!currentTask.result_urls || currentTask.result_urls.length <= 1))) {
                        event.preventDefault();
                        if (event.key === 'ArrowUp' || event.key === 'ArrowLeft') {
                            switchTask('prev');
                        } else {
                            switchTask('next');
                        }
                    }
                };

                // é¼ æ ‡æ»šè½®äº‹ä»¶å¤„ç†
                this.taskWheelHandler = (event) => {
                    const modal = document.getElementById('taskDetailModal');
                    if (modal.style.display !== 'flex') return;

                    // æ£€æŸ¥æ˜¯å¦åœ¨é¢„è§ˆåŒºåŸŸ
                    const previewArea = document.querySelector('.task-detail-preview');
                    if (previewArea && previewArea.contains(event.target)) {
                        return; // åœ¨é¢„è§ˆåŒºåŸŸæ—¶ä¸å¤„ç†
                    }

                    event.preventDefault();
                    if (event.deltaY > 0) {
                        // å‘ä¸‹æ»šåŠ¨ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡
                        switchTask('next');
                    } else {
                        // å‘ä¸Šæ»šåŠ¨ï¼Œåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªä»»åŠ¡
                        switchTask('prev');
                    }
                };

                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                document.addEventListener('keydown', this.taskNavigationHandler);
                const modal = document.getElementById('taskDetailModal');
                modal.addEventListener('wheel', this.taskWheelHandler, { passive: false });
            }

            // æ¸²æŸ“ä»»åŠ¡è¯¦æƒ…
            renderTaskDetail(taskId) {
                const task = this.tasks[taskId];
                if (!task) return;

                // ç¡®ä¿å½“å‰å›¾ç‰‡ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
                if (task.result_urls && task.result_urls.length > 0) {
                    this.currentImageIndex = Math.max(0, Math.min(this.currentImageIndex || 0, task.result_urls.length - 1));
                } else {
                    this.currentImageIndex = 0;
                }

                // è®¡ç®—ç”¨æ—¶
                let duration = '';
                if (task.created_at && task.completed_at) {
                    const start = new Date(task.created_at);
                    const end = new Date(task.completed_at);
                    const seconds = Math.round((end - start) / 1000);
                    duration = seconds;
                }

                // æ¸²æŸ“å›¾ç‰‡ - å¤šå›¾æ—¶åªæ˜¾ç¤ºä¸€å¼ 
                const imagesContainer = document.getElementById('taskDetailImages');
                const bottomThumbnailsContainer = document.getElementById('taskDetailBottomThumbnails');
                
                if (task.result_urls && task.result_urls.length > 0) {
                    // å¤šå›¾æ¨¡å¼ï¼šåªæ˜¾ç¤ºå½“å‰ç´¢å¼•çš„å›¾ç‰‡
                    const currentUrl = task.result_urls[this.currentImageIndex];
                    const imageHtml = `
                        <div class="image-grid-item" style="position: relative; min-height: 500px; max-height: 100%;">
                            <img src="${currentUrl}" 
                                 alt="ç”Ÿæˆç»“æœ ${this.currentImageIndex + 1}" 
                                 loading="lazy"
                                 onload="this.style.opacity='1'; this.setAttribute('data-loaded', 'true'); manager.cropWhiteBackground(this);"
                                 oncontextmenu="event.stopPropagation();"
                                 style="pointer-events: auto; position: relative; z-index: 0; max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; display: block; opacity: 0; transition: opacity 0.2s ease;">
                                </div>
                    `;
                    imagesContainer.innerHTML = `<div class="image-grid">${imageHtml}</div>`;
                    
                    // å¤„ç†å·²åŠ è½½çš„å›¾ç‰‡ï¼ˆä»ç¼“å­˜ä¸­åŠ è½½çš„ï¼‰
                    setTimeout(() => {
                        const img = imagesContainer.querySelector('img');
                        if (img && img.complete && !img.hasAttribute('data-loaded')) {
                            img.style.opacity = '1';
                            img.setAttribute('data-loaded', 'true');
                        }
                    }, 50);
                    
                    // æ˜¾ç¤ºå¹¶æ¸²æŸ“åº•éƒ¨ç¼©ç•¥å›¾åˆ—è¡¨
                    bottomThumbnailsContainer.style.display = 'flex';
                    this.renderBottomThumbnails(task.result_urls, taskId);
                } else if (task.result_url) {
                    // å•å›¾æ¨¡å¼
                    const imageHtml = `
                        <div class="image-grid-item" style="position: relative; min-height: 500px; max-height: 100%;">
                            <img src="${task.result_url}" 
                                 alt="ç”Ÿæˆç»“æœ" 
                                 loading="lazy"
                                 onload="this.style.opacity='1'; this.setAttribute('data-loaded', 'true'); manager.cropWhiteBackground(this);"
                                 oncontextmenu="event.stopPropagation();"
                                 style="pointer-events: auto; position: relative; z-index: 0; max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; display: block; opacity: 0; transition: opacity 0.2s ease;">
                        </div>
                    `;
                    imagesContainer.innerHTML = `<div class="image-grid">${imageHtml}</div>`;
                    
                    // å¤„ç†å·²åŠ è½½çš„å›¾ç‰‡ï¼ˆä»ç¼“å­˜ä¸­åŠ è½½çš„ï¼‰
                    setTimeout(() => {
                        const img = imagesContainer.querySelector('img');
                        if (img && img.complete && !img.hasAttribute('data-loaded')) {
                            img.style.opacity = '1';
                            img.setAttribute('data-loaded', 'true');
                        }
                    }, 50);
                    
                    // éšè—åº•éƒ¨ç¼©ç•¥å›¾åˆ—è¡¨
                    bottomThumbnailsContainer.style.display = 'none';
                } else {
                    imagesContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #757575;">æ— å›¾ç‰‡</div>';
                    bottomThumbnailsContainer.style.display = 'none';
                }

                // æ¸²æŸ“å‚æ•°ä¿¡æ¯
                const paramsContainer = document.getElementById('taskDetailParams');
                paramsContainer.innerHTML = this.renderGenerationParams(task, duration);

                // å¯¹å·²åŠ è½½çš„å›¾ç‰‡åº”ç”¨è£å‰ª
                setTimeout(() => {
                    const images = imagesContainer.querySelectorAll('img');
                    images.forEach(img => {
                        if (img.complete) {
                            this.cropWhiteBackground(img);
                        }
                    });
                }, 100);
            }

            // æ¸²æŸ“åº•éƒ¨ç¼©ç•¥å›¾åˆ—è¡¨
            renderBottomThumbnails(urls, taskId) {
                const bottomThumbnailsContainer = document.getElementById('taskDetailBottomThumbnails');
                const thumbnailsHtml = urls.map((url, index) => `
                    <div class="thumbnail-item ${index === this.currentImageIndex ? 'active' : ''}" 
                         onclick="manager.switchToImage(${index}, '${taskId}')">
                        <img src="${url}" alt="ç¼©ç•¥å›¾ ${index + 1}" loading="lazy">
                    </div>
                `).join('');
                bottomThumbnailsContainer.innerHTML = thumbnailsHtml;
            }

            // åˆ‡æ¢æ˜¾ç¤ºçš„å›¾ç‰‡
            switchToImage(index, taskId) {
                const task = this.tasks[taskId];
                if (!task || !task.result_urls || index < 0 || index >= task.result_urls.length) {
                    return;
                }

                this.currentImageIndex = index;
                
                // æ›´æ–°ä¸»å›¾ç‰‡
                const imagesContainer = document.getElementById('taskDetailImages');
                const currentUrl = task.result_urls[index];
                const imageHtml = `
                    <div class="image-grid-item" style="position: relative; min-height: 200px; max-height: 100%;">
                        <img src="${currentUrl}" 
                             alt="ç”Ÿæˆç»“æœ ${index + 1}" 
                             loading="lazy"
                             onload="this.style.opacity='1'; this.setAttribute('data-loaded', 'true'); manager.cropWhiteBackground(this);"
                             oncontextmenu="event.stopPropagation();"
                             style="pointer-events: auto; position: relative; z-index: 0; max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; display: block; opacity: 0; transition: opacity 0.2s ease;">
                    </div>
                `;
                imagesContainer.innerHTML = `<div class="image-grid">${imageHtml}</div>`;
                
                // å¤„ç†å·²åŠ è½½çš„å›¾ç‰‡ï¼ˆä»ç¼“å­˜ä¸­åŠ è½½çš„ï¼‰
                setTimeout(() => {
                    const img = imagesContainer.querySelector('img');
                    if (img && img.complete && !img.hasAttribute('data-loaded')) {
                        img.style.opacity = '1';
                        img.setAttribute('data-loaded', 'true');
                    }
                }, 50);
                
                // æ›´æ–°åº•éƒ¨ç¼©ç•¥å›¾çš„æ¿€æ´»çŠ¶æ€
                const thumbnails = document.querySelectorAll('.thumbnail-item');
                thumbnails.forEach((thumb, i) => {
                    if (i === index) {
                        thumb.classList.add('active');
                    } else {
                        thumb.classList.remove('active');
                    }
                });
                
                // å¯¹å·²åŠ è½½çš„å›¾ç‰‡åº”ç”¨è£å‰ª
                setTimeout(() => {
                    const images = imagesContainer.querySelectorAll('img');
                    images.forEach(img => {
                        if (img.complete) {
                            this.cropWhiteBackground(img);
                        }
                    });
                }, 100);
            }

            // æ¸²æŸ“é¢„è§ˆåˆ—è¡¨
            renderPreviewList(currentTaskId) {
                const previewContainer = document.getElementById('taskDetailPreviewList');
                
                // è·å–æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡
                const completedTasks = Object.values(this.tasks).filter(task => 
                    task.status === 'completed' && (task.result_url || (task.result_urls && task.result_urls.length > 0))
                ).sort((a, b) => {
                    // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
                    const timeA = new Date(a.created_at || 0).getTime();
                    const timeB = new Date(b.created_at || 0).getTime();
                    return timeB - timeA;
                });

                if (completedTasks.length === 0) {
                    previewContainer.innerHTML = '<div style="text-align: center; color: #757575; font-size: 0.9rem;">æš‚æ— ä»»åŠ¡</div>';
                    return;
                }

                const previewHtml = completedTasks.map(task => {
                    // è·å–ç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼©ç•¥å›¾
                    let thumbnailUrl = '';
                    if (task.result_urls && task.result_urls.length > 0) {
                        thumbnailUrl = task.result_urls[0];
                    } else if (task.result_url) {
                        thumbnailUrl = task.result_url;
                    }

                    const isActive = task.task_id === currentTaskId;
                    return `
                        <div class="preview-item ${isActive ? 'active' : ''}" 
                             onclick="event.stopPropagation(); manager.renderTaskDetail('${task.task_id}'); manager.updatePreviewActive('${task.task_id}')">
                            ${thumbnailUrl ? `<img src="${thumbnailUrl}" alt="é¢„è§ˆ" loading="lazy">` : '<div style="width: 100%; height: 100%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; color: #757575; font-size: 0.8rem;">æ— å›¾</div>'}
                        </div>
                    `;
                }).join('');

                previewContainer.innerHTML = previewHtml;
            }

            // æ›´æ–°é¢„è§ˆåˆ—è¡¨çš„æ¿€æ´»çŠ¶æ€
            updatePreviewActive(taskId) {
                const previewItems = document.querySelectorAll('.preview-item');
                previewItems.forEach(item => {
                    item.classList.remove('active');
                });
                
                const activeItem = Array.from(previewItems).find(item => {
                    const onclick = item.getAttribute('onclick');
                    return onclick && onclick.includes(`'${taskId}'`);
                });
                
                if (activeItem) {
                    activeItem.classList.add('active');
                    // æ»šåŠ¨åˆ°æ¿€æ´»é¡¹ï¼ˆåœ¨é¢„è§ˆå®¹å™¨å†…ï¼‰
                    const previewContainer = document.querySelector('.task-detail-preview');
                    if (previewContainer) {
                        const containerRect = previewContainer.getBoundingClientRect();
                        const itemRect = activeItem.getBoundingClientRect();
                        const scrollTop = previewContainer.scrollTop || 0;
                        const itemTop = itemRect.top - containerRect.top + scrollTop;
                        previewContainer.scrollTo({
                            top: itemTop - previewContainer.offsetHeight / 2 + activeItem.offsetHeight / 2,
                            behavior: 'smooth'
                        });
                    }
                }
            }

            syncParamsHeight() {
                // å‚æ•°åŒºåŸŸå·²ä½¿ç”¨å›ºå®šé«˜åº¦ï¼ˆ200pxï¼‰ï¼Œå†…å®¹å¯ä»¥æ»šåŠ¨æŸ¥çœ‹å®Œæ•´ä¿¡æ¯
                // ä¸å†éœ€è¦åº”ç”¨æˆªæ–­æ ·å¼ï¼Œè®©æ–‡å­—å®Œæ•´æ˜¾ç¤º
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        const resultContainers = document.querySelectorAll('.result-container');
                        resultContainers.forEach(container => {
                            const paramsContent = container.querySelector('.generation-params .params-content');
                            
                            if (paramsContent) {
                                // ç¡®ä¿å‚æ•°å€¼å¯ä»¥å®Œæ•´æ˜¾ç¤ºï¼Œä¸æˆªæ–­
                                const paramValues = paramsContent.querySelectorAll('.param-value');
                                paramValues.forEach(value => {
                                    value.style.display = 'block';
                                    value.style.overflow = 'visible';
                                    value.style.webkitLineClamp = 'unset';
                                    value.style.webkitBoxOrient = 'unset';
                                    value.style.textOverflow = 'unset';
                                    value.style.maxHeight = 'none';
                                });
                            }
                        });
                        
                        // ç›‘å¬å›¾ç‰‡åŠ è½½ï¼Œå›¾ç‰‡åŠ è½½å®Œæˆåé‡æ–°åŒæ­¥é«˜åº¦å¹¶è®¡ç®—å®¹å™¨å®½åº¦
                        const images = document.querySelectorAll('.result-container .image-grid-item img');
                        let loadedCount = 0;
                        const totalImages = images.length;
                        
                        // æ ¹æ®å›¾ç‰‡å®é™…æ¯”ä¾‹è®¡ç®—å®¹å™¨å®½åº¦
                        const adjustImageContainerWidth = (img) => {
                            const container = img.closest('.image-grid-item');
                            const imageGrid = container?.closest('.image-grid');
                            // å¦‚æœæ˜¯4å¼ 1:1å›¾ç‰‡çš„å¸ƒå±€ï¼Œä¸è°ƒæ•´å®½åº¦ï¼ˆç”±CSSå›ºå®šï¼‰
                            if (imageGrid && imageGrid.classList.contains('image-grid-4x1')) {
                                return;
                            }
                            if (container && img.naturalWidth && img.naturalHeight) {
                                const aspectRatio = img.naturalWidth / img.naturalHeight;
                                const fixedHeight = 500;
                                const calculatedWidth = fixedHeight * aspectRatio;
                                // é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤§å›¾é—ªç°
                                const maxWidth = container.closest('.result-container')?.offsetWidth || window.innerWidth;
                                const finalWidth = Math.min(calculatedWidth, maxWidth - 20); // å‡å»paddingå’Œgap
                                container.style.width = finalWidth + 'px';
                                container.style.maxWidth = finalWidth + 'px';
                            }
                        };
                        
                        if (totalImages === 0) {
                            // æ²¡æœ‰å›¾ç‰‡ï¼Œç«‹å³åŒæ­¥
                            setTimeout(() => this.syncParamsHeight(), 200);
                        } else {
                            images.forEach(img => {
                                if (!img.hasAttribute('data-sync-listener')) {
                                    img.setAttribute('data-sync-listener', 'true');
                                    if (!img.complete) {
                                        img.addEventListener('load', () => {
                                            adjustImageContainerWidth(img);
                                            loadedCount++;
                                            if (loadedCount === totalImages) {
                                                // æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆï¼ŒåŒæ­¥é«˜åº¦
                                                setTimeout(() => this.syncParamsHeight(), 200);
                                            }
                                        }, { once: true });
                                    } else {
                                        adjustImageContainerWidth(img);
                                        loadedCount++;
                                        if (loadedCount === totalImages) {
                                            // æ‰€æœ‰å›¾ç‰‡å·²åŠ è½½ï¼Œç«‹å³åŒæ­¥
                                            setTimeout(() => this.syncParamsHeight(), 200);
                                        }
                                    }
                                }
                            });
                        }
                    }, 50);
                });
            }
        }

        // å…³é—­å›¾ç‰‡æ¨¡æ€æ¡†
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'none';
            // éšè—å›¾ç‰‡å¹¶é‡ç½®æ ·å¼
            modalImg.style.display = 'none';
            modalImg.style.opacity = '0';
            modalImg.style.clipPath = 'none';
            modalImg.style.width = 'auto';
            modalImg.style.height = 'auto';
        }

        // å…³é—­ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡†
        function closeTaskDetailModal() {
            const modal = document.getElementById('taskDetailModal');
            modal.style.display = 'none';
            
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            if (manager.taskNavigationHandler) {
                document.removeEventListener('keydown', manager.taskNavigationHandler);
                manager.taskNavigationHandler = null;
            }
            if (manager.taskWheelHandler) {
                modal.removeEventListener('wheel', manager.taskWheelHandler);
                manager.taskWheelHandler = null;
            }
        }

        // å·¥ä½œæµåˆ‡æ¢å‡½æ•°
        function switchWorkflow() {
            const workflowType = document.getElementById('workflowType').value;
            const imageUploadGroup = document.getElementById('imageUploadGroup');
            const promptGroup = document.getElementById('promptGroup');
            const negativePromptGroup = document.getElementById('negativePromptGroup');
            const sizeGroup = document.getElementById('sizeGroup');
            const samplingGroup = document.getElementById('samplingGroup');
            const advancedGroup = document.getElementById('advancedGroup');
            const img2imgParams = document.getElementById('img2imgParams');

            // éšè—æ‰€æœ‰ç‰¹æ®Šå‚æ•°
            img2imgParams.style.display = 'none';

            switch(workflowType) {
                case 'qwen_text2img':
                    // Qwen æ–‡ç”Ÿå›¾ï¼šä¸éœ€è¦ä¸Šä¼ å›¾ç‰‡
                    imageUploadGroup.style.display = 'none';
                    promptGroup.style.display = 'block';
                    negativePromptGroup.style.display = 'block';
                    sizeGroup.style.display = 'grid';
                    samplingGroup.style.display = 'grid';
                    advancedGroup.style.display = 'grid';
                    break;

                case 'qwen_img2img':
                    // Qwen å›¾ç”Ÿå›¾ï¼šéœ€è¦ä¸Šä¼ å›¾ç‰‡ï¼Œæ”¯æŒå¤šå¼ 
                    imageUploadGroup.style.display = 'block';
                    promptGroup.style.display = 'block';
                    negativePromptGroup.style.display = 'block';
                    sizeGroup.style.display = 'grid';
                    samplingGroup.style.display = 'grid';
                    advancedGroup.style.display = 'grid';
                    img2imgParams.style.display = 'block';
                    break;

                case 'rembg':
                    // è§’è‰²æŠ å›¾ï¼šåªéœ€è¦ä¸Šä¼ å›¾ç‰‡
                    imageUploadGroup.style.display = 'block';
                    promptGroup.style.display = 'none';
                    negativePromptGroup.style.display = 'none';
                    sizeGroup.style.display = 'none';
                    samplingGroup.style.display = 'none';
                    advancedGroup.style.display = 'none';
                    break;
            }
        }

        // è®¾ç½®å¤šä¸ªå›¾ç‰‡ä¸Šä¼ åŒºåŸŸ
        function setupMultipleImageUploads() {
            // ç¬¬2å¼ å›¾ç‰‡
            const imageUploadArea2 = document.getElementById('imageUploadArea2');
            const inputImage2 = document.getElementById('inputImage2');
            const uploadContent2 = document.getElementById('uploadContent2');
            const imagePreview2 = document.getElementById('imagePreview2');
            const previewImg2 = document.getElementById('previewImg2');

            imageUploadArea2.addEventListener('click', () => inputImage2.click());
            inputImage2.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg2.src = e.target.result;
                        uploadContent2.style.display = 'none';
                        imagePreview2.style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // ç¬¬3å¼ å›¾ç‰‡
            const imageUploadArea3 = document.getElementById('imageUploadArea3');
            const inputImage3 = document.getElementById('inputImage3');
            const uploadContent3 = document.getElementById('uploadContent3');
            const imagePreview3 = document.getElementById('imagePreview3');
            const previewImg3 = document.getElementById('previewImg3');

            imageUploadArea3.addEventListener('click', () => inputImage3.click());
            inputImage3.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg3.src = e.target.result;
                        uploadContent3.style.display = 'none';
                        imagePreview3.style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å·¥ä½œæµ
        window.addEventListener('DOMContentLoaded', function() {
            switchWorkflow();
            setupMultipleImageUploads();
        });

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
                closeTaskDetailModal();
            }
        });

        // å…¨å±€å®ä¾‹
        let manager;
        try {
            manager = new BatchGenerationManager();
            console.log('BatchGenerationManager åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('BatchGenerationManager åˆå§‹åŒ–å¤±è´¥:', error);
        }

        // å…¨å±€å‡½æ•°
        function submitSingle() {
            console.log('å…¨å±€ submitSingle å‡½æ•°è¢«è°ƒç”¨');
            if (!manager) {
                console.error('Manager æœªåˆå§‹åŒ–!');
                alert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            try {
                manager.apiServer = document.getElementById('apiServer').value;
                manager.submitSingle();
            } catch (error) {
                console.error('submitSingle æ‰§è¡Œé”™è¯¯:', error);
                alert('æäº¤å¤±è´¥: ' + error.message);
            }
        }

        function refreshTasks() {
            manager.apiServer = document.getElementById('apiServer').value;
            manager.refreshTasks();
        }

        function clearCompleted() {
            manager.clearCompleted();
        }

        // æ‰“å¼€ç»Ÿè®¡å¼¹çª—
        function openStatsModal() {
            const modal = document.getElementById('statsModal');
            if (!modal) return;
            
            // æ›´æ–°å¼¹çª—ä¸­çš„ç»Ÿè®¡æ•°æ®
            updateStatsModal();
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.style.display = 'flex';
            
            // æ·»åŠ ESCé”®å…³é—­ç›‘å¬
            document.addEventListener('keydown', handleStatsModalEscape);
        }

        // å…³é—­ç»Ÿè®¡å¼¹çª—
        function closeStatsModal() {
            const modal = document.getElementById('statsModal');
            if (!modal) return;
            
            modal.style.display = 'none';
            
            // ç§»é™¤ESCé”®ç›‘å¬
            document.removeEventListener('keydown', handleStatsModalEscape);
        }

        // ESCé”®å…³é—­å¼¹çª—
        function handleStatsModalEscape(event) {
            if (event.key === 'Escape') {
                closeStatsModal();
            }
        }

        // æ›´æ–°å¼¹çª—ä¸­çš„ç»Ÿè®¡æ•°æ®
        function updateStatsModal() {
            if (!manager) return;
            
            const tasks = Object.values(manager.tasks);
            const totalTasks = tasks.length;
            const runningTasks = tasks.filter(t => t.status === 'running' || t.status === 'generating' || t.status === 'pending').length;
            const completedTasks = tasks.filter(t => t.status === 'completed').length;
            const failedTasks = tasks.filter(t => t.status === 'failed').length;
            
            const totalEl = document.getElementById('statsModalTotalTasks');
            const runningEl = document.getElementById('statsModalRunningTasks');
            const completedEl = document.getElementById('statsModalCompletedTasks');
            const failedEl = document.getElementById('statsModalFailedTasks');
            
            if (totalEl) totalEl.textContent = totalTasks;
            if (runningEl) runningEl.textContent = runningTasks;
            if (completedEl) completedEl.textContent = completedTasks;
            if (failedEl) failedEl.textContent = failedTasks;
        }

        // å›¾ç‰‡ä¸Šä¼ ç›¸å…³åŠŸèƒ½
        function initImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const fileInput = document.getElementById('inputImage');
            const uploadContent = document.getElementById('uploadContent');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');

            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadArea.addEventListener('click', (e) => {
                // å¦‚æœç‚¹å‡»çš„æ˜¯ç§»é™¤æŒ‰é’®ï¼Œä¸è§¦å‘æ–‡ä»¶é€‰æ‹©
                if (e.target.closest('.btn-small')) {
                    return;
                }
                fileInput.click();
            });

            // æ–‡ä»¶é€‰æ‹©å¤„ç†
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageFile(file);
                }
            });

            // æ‹–æ‹½åŠŸèƒ½
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        fileInput.files = files;
                        handleImageFile(file);
                    }
                }
            });

            // ç²˜è´´åŠŸèƒ½
            document.addEventListener('paste', (e) => {
                const items = e.clipboardData.items;
                for (let item of items) {
                    if (item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) {
                            // åˆ›å»ºFileListå¯¹è±¡
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            fileInput.files = dataTransfer.files;
                            handleImageFile(file);
                        }
                        break;
                    }
                }
            });

            // å¤„ç†å›¾ç‰‡æ–‡ä»¶
            function handleImageFile(file) {
                // éªŒè¯æ–‡ä»¶å¤§å° (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    manager.showErrorMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
                    return;
                }

                // éªŒè¯æ–‡ä»¶ç±»å‹
                if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
                    manager.showErrorMessage('åªæ”¯æŒ JPG å’Œ PNG æ ¼å¼çš„å›¾ç‰‡');
                    return;
                }

                // è¯»å–å¹¶æ˜¾ç¤ºå›¾ç‰‡
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    uploadContent.style.display = 'none';
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // ç§»é™¤å›¾ç‰‡
        function removeImage() {
            const fileInput = document.getElementById('inputImage');
            const uploadContent = document.getElementById('uploadContent');
            const imagePreview = document.getElementById('imagePreview');
            
            fileInput.value = '';
            uploadContent.style.display = 'block';
            imagePreview.style.display = 'none';
        }

        // æ›´æ–°å®½é«˜æ¯”ä¾‹
        function updateAspectRatio() {
            const aspectRatio = document.getElementById('aspectRatio').value;
            const widthInput = document.getElementById('width');
            const heightInput = document.getElementById('height');
            
            const aspectRatios = {
                '1:1': { width: 1024, height: 1024 },
                '16:9': { width: 1664, height: 928 },
                '9:16': { width: 928, height: 1664 },
                '4:3': { width: 1472, height: 1140 },
                '3:4': { width: 1140, height: 1472 },
                '3:2': { width: 1584, height: 1056 },
                '2:3': { width: 1056, height: 1584 }
            };
            
            if (aspectRatios[aspectRatio]) {
                widthInput.value = aspectRatios[aspectRatio].width;
                heightInput.value = aspectRatios[aspectRatio].height;
            }
        }

        // ç§»åŠ¨ç«¯æ›´æ–°å®½é«˜æ¯”ä¾‹
        function updateAspectRatioMobile() {
            const aspectRatio = document.getElementById('aspectRatioMobile').value;
            const widthInput = document.getElementById('width');
            const heightInput = document.getElementById('height');
            
            const aspectRatios = {
                '1:1': { width: 1024, height: 1024 },
                '16:9': { width: 1664, height: 928 },
                '9:16': { width: 928, height: 1664 },
                '4:3': { width: 1472, height: 1140 },
                '3:4': { width: 1140, height: 1472 },
                '3:2': { width: 1584, height: 1056 },
                '2:3': { width: 1056, height: 1584 }
            };
            
            if (aspectRatios[aspectRatio]) {
                widthInput.value = aspectRatios[aspectRatio].width;
                heightInput.value = aspectRatios[aspectRatio].height;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('HOJO AIå·²åŠ è½½');
            initImageUpload();
            initTaskStatsState(); // åˆå§‹åŒ–ä»»åŠ¡ç›‘æ§å±•å¼€æ”¶èµ·çŠ¶æ€
            
            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°åŒæ­¥å‚æ•°ä¿¡æ¯åŒºåŸŸé«˜åº¦
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (manager) {
                        manager.syncParamsHeight();
                    }
                }, 250);
            });
        });
    </script>
</body>
</html>

