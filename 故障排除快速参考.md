# 🔧 故障排除快速参考

> 本文档总结了常见网络连接和API配置问题的快速解决方案

## 📋 问题快速索引

- [API连接失败](#api连接失败)
- [Git连接GitHub失败](#git连接github失败)
- [任务状态获取失败](#任务状态获取失败)
- [图片无法显示](#图片无法显示)
- [ComfyUI连接问题](#comfyui连接问题)

---

## 🔌 API连接失败

### 症状
- 前端显示"API连接失败"
- 无法提交任务
- 无法获取任务状态

### 快速检查清单

1. **API服务器是否运行？**
   ```bash
   # 测试健康检查
   curl http://localhost:8001/health
   ```

2. **API地址是否正确？**
   - 本机运行：`http://localhost:8001`
   - 其他电脑：`http://192.168.x.x:8001`（使用实际IP）
   - 不能使用 `localhost` 访问其他电脑的服务器

3. **端口是否被占用？**
   ```bash
   # Windows
   netstat -ano | findstr :8001
   
   # Linux/Mac
   lsof -i :8001
   ```

### 解决方案

**情况1：API服务器在本机**
```bash
# 启动API服务器
python comfyui_api_server.py

# 在Web界面使用：http://localhost:8001
```

**情况2：API服务器在其他电脑**
```bash
# 1. 获取API服务器所在电脑的IP
# Windows: ipconfig
# Linux/Mac: ifconfig

# 2. 在Web界面修改API地址为：http://192.168.x.x:8001
```

**情况3：从其他设备访问**
- 确保防火墙允许8001端口
- 使用局域网IP地址（不是localhost）

---

## 🔗 Git连接GitHub失败

### 症状
```
fatal: unable to access 'https://github.com/...': Recv failure: Connection was reset
```

### 快速解决方案

**方法1：配置代理（推荐）**
```bash
# 1. 查看系统代理设置（通常在代理软件中）
# 常见端口：7890 (Clash), 10809 (V2Ray), 1080 (SOCKS5)

# 2. 配置Git代理
git config --global http.proxy http://127.0.0.1:7890
git config --global https.proxy http://127.0.0.1:7890

# 3. 验证
git config --global --get http.proxy
git fetch origin
```

**方法2：清除代理**
```bash
git config --global --unset http.proxy
git config --global --unset https.proxy
```

---

## 📊 任务状态获取失败

### 症状
- 任务提交成功，但显示"无法获取任务状态"
- 任务一直处于"generating"状态
- 显示"API连接失败，无法获取任务状态"

### 快速检查

1. **API端点是否正确？**
   - 正确：`GET /status/{task_id}`
   - 错误：`GET /task/{task_id}`（已修复）

2. **网络是否稳定？**
   - 代码已实现自动重试（最多5次）
   - 查看浏览器控制台（F12）的错误信息

3. **任务ID是否正确？**
   ```javascript
   // 在浏览器控制台测试
   fetch('http://localhost:8001/status/任务ID')
     .then(r => r.json())
     .then(console.log);
   ```

### 解决方案

**已实现的自动修复：**
- ✅ 自动重试机制（连续失败5次后停止）
- ✅ 失败后自动增加重试延迟
- ✅ 网络错误时自动重新测试连接

**手动调试：**
1. 打开浏览器控制台（F12）
2. 查看Network标签的请求
3. 检查失败的请求和错误信息

---

## 🖼️ 图片无法显示

### 症状
- 任务显示"生成成功"，但图片无法显示
- 浏览器控制台显示图片加载失败
- 图片显示为损坏状态

### 根本原因
- API返回的图片URL是相对路径：`/images/filename.png`
- 浏览器需要完整URL：`http://localhost:8001/images/filename.png`

### 解决方案

**已实现的自动修复：**
- ✅ 前端已添加 `getImageUrl()` 函数
- ✅ 自动将相对路径转换为完整URL
- ✅ 所有图片显示位置都已修复

**验证方法：**
```javascript
// 在浏览器控制台检查
fetch('http://localhost:8001/status/任务ID')
  .then(r => r.json())
  .then(task => {
    console.log('图片URL:', task.result_urls);
    // 应该显示完整URL
  });
```

**手动检查：**
1. 确认 `generated_images` 目录存在
2. 确认图片文件存在
3. 直接在浏览器访问：`http://localhost:8001/images/文件名.png`

---

## 🌐 ComfyUI连接问题

### 症状
- 任务提交后一直处于"生成中"
- 日志显示"连接ComfyUI服务器失败"
- 任务超时

### 快速检查清单

1. **ComfyUI服务器地址配置**
   ```python
   # 编辑 comfyui_api_server.py
   COMFYUI_SERVER = "http://你的ComfyUI地址:8188"
   ```

2. **网络连通性测试**
   ```bash
   curl http://你的ComfyUI地址:8188/system_stats
   ```

3. **查看日志**
   ```bash
   # Windows
   Get-Content logs\api_server.log -Tail 50
   
   # Linux/Mac
   tail -f logs/api_server.log
   ```

### 解决方案

**已实现的自动修复：**
- ✅ HTTP请求超时配置（连接10秒，读取60秒）
- ✅ 自动重试机制（最多3次）
- ✅ 连续失败10次后标记任务失败

**手动修复：**
1. 检查ComfyUI服务器是否运行
2. 检查网络连接
3. 检查防火墙设置
4. 查看ComfyUI服务器日志

---

## 🛠️ 常用调试命令

### 测试API服务器
```bash
# 健康检查
curl http://localhost:8001/health

# 获取所有任务
curl http://localhost:8001/tasks

# 获取任务状态
curl http://localhost:8001/status/任务ID
```

### 查看日志
```bash
# Windows PowerShell
Get-Content logs\api_server.log -Tail 100 -Wait

# Linux/Mac
tail -f logs/api_server.log
```

### 检查端口占用
```bash
# Windows
netstat -ano | findstr :8001

# Linux/Mac
lsof -i :8001
```

### 浏览器调试
1. 按F12打开开发者工具
2. Console标签：查看错误信息
3. Network标签：查看请求和响应
4. Application标签：查看localStorage数据

---

## 📝 关键经验总结

### 1. API地址配置原则
- **本机运行**：使用 `localhost` 或 `127.0.0.1`
- **其他电脑**：必须使用实际IP地址，不能使用 `localhost`
- **跨设备访问**：使用局域网IP，确保防火墙允许

### 2. 相对路径 vs 绝对路径
- API返回的相对路径需要拼接服务器地址
- 前端已实现自动转换，无需手动处理

### 3. 网络连接稳定性
- 已实现自动重试机制，提高稳定性
- 连续失败多次后才标记为失败
- 失败后自动尝试重连

### 4. 错误诊断流程
1. 检查服务是否运行
2. 检查网络连通性
3. 查看日志文件
4. 使用浏览器开发者工具
5. 测试API端点

---

## 🔍 快速诊断流程图

```
问题：API连接失败
    ↓
检查1：API服务器是否运行？
    ├─ 是 → 检查2
    └─ 否 → 启动服务器：python comfyui_api_server.py
            ↓
检查2：API地址是否正确？
    ├─ 是 → 检查3
    └─ 否 → 修改Web界面中的API地址
            ↓
检查3：端口是否被占用？
    ├─ 是 → 停止占用进程或更换端口
    └─ 否 → 检查4
            ↓
检查4：防火墙是否允许？
    ├─ 是 → 查看日志文件
    └─ 否 → 允许8001端口
```

---

## 📚 相关文档

- [完整README](README.md) - 详细故障排除指南
- [部署指南](README_批量生图平台.md) - 完整部署说明
- [使用指南](使用指南.md) - 功能使用说明

---

**最后更新：** 2025-11-11  
**维护者：** 项目团队

